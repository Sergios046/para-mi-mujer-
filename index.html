<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Para Saharaim ğŸ’—</title>
  <style>
    :root{
      --bg1:#fff7fb;
      --bg2:#f5f0ff;
      --ink:#2b2b33;
      --muted:#6a6a7a;
      --card:rgba(255,255,255,.78);
      --stroke:rgba(120,120,150,.22);
      --shadow: 0 18px 45px rgba(25, 20, 40, .12);
      --shadow2: 0 10px 24px rgba(25, 20, 40, .10);
      --r: 22px;
      --btnInk:#2b2b33;
      --accent:#ff5da2;
      --accent2:#7c5cff;
      --good:#17b26a;
      --warn:#ffb020;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--ink);
      overflow-x:hidden;
      background:
        radial-gradient(1200px 600px at 15% 5%, rgba(255,93,162,.20), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(124,92,255,.18), transparent 55%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
    }

    /* âœ… Fondo con foto: sin â€œestiradito raroâ€ */
    .bgPhoto{
      position:fixed; inset:0;
      background: url("assets/photos/bg.jpeg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      z-index:-3;
      filter: saturate(1.12) contrast(1.03) brightness(1.05);
      transform: none; /* <-- antes era scale(...) y se veÃ­a raro */
      will-change: auto;
    }
    .bgOverlay{
      position:fixed; inset:0;
      background:
        radial-gradient(900px 500px at 15% 5%, rgba(255,93,162,.12), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(124,92,255,.10), transparent 55%),
        linear-gradient(180deg, rgba(255,247,251,.50), rgba(245,240,255,.52));
      backdrop-filter: blur(6px);
      z-index:-2;
      pointer-events:none;
    }

    /* Corazones */
    .heartsLayer{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:-1;
      overflow:hidden;
    }
    .heart{
      position:absolute;
      bottom:-40px;
      font-size:18px;
      opacity:.90;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.18));
      animation: floatUp linear forwards;
      will-change: transform, opacity;
      user-select:none;
    }
    @keyframes floatUp{
      0%{ transform: translateY(0) translateX(0) rotate(0deg); opacity:.0;}
      10%{ opacity:.92;}
      100%{ transform: translateY(-120vh) translateX(var(--drift)) rotate(var(--rot)); opacity:0;}
    }

    /* Confeti layer */
    .confettiLayer{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:50;
      overflow:hidden;
    }
    .confetti{
      position:absolute;
      top:-30px;
      font-size:18px;
      opacity:.95;
      filter: drop-shadow(0 8px 16px rgba(0,0,0,.14));
      animation: confettiFall linear forwards;
      will-change: transform, opacity;
      user-select:none;
    }
    @keyframes confettiFall{
      0%{ transform: translateY(0) translateX(0) rotate(0deg); opacity:0; }
      10%{ opacity:.95; }
      100%{ transform: translateY(120vh) translateX(var(--drift)) rotate(var(--rot)); opacity:0; }
    }

    .wrap{
      max-width: 1120px;
      margin: 24px auto 60px;
      padding: 0 14px;
    }

    .topbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border:1px solid var(--stroke);
      border-radius: 999px;
      background: rgba(255,255,255,.72);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(120,120,150,.18);
    }
    .pill{
      display:flex; align-items:center; gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(120,120,150,.18);
      background: rgba(255,255,255,.72);
      box-shadow: 0 8px 18px rgba(25,20,40,.08);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .pill:hover{ transform: translateY(-1px); box-shadow: 0 12px 22px rgba(25,20,40,.10); }
    .pill:active{ transform: translateY(0px); }

    .grid{
      margin-top: 16px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      border:1px solid var(--stroke);
      background: var(--card);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      overflow:hidden;
    }
    .panelHeader{
      padding: 16px 18px 10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .panelHeader h2{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .sub{
      margin:0;
      padding:0 18px 14px;
      color:var(--muted);
      font-size: 13px;
    }

    .menuCards{
      padding: 0 14px 16px;
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 650px){
      .menuCards{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    }

    .cardBtn{
      position:relative;
      text-align:left;
      padding: 12px 12px 11px;
      border-radius: 16px;
      border: 1px solid rgba(120,120,150,.18);
      background: rgba(255,255,255,.72);
      box-shadow: 0 10px 24px rgba(25,20,40,.08);
      cursor:pointer;
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      min-height: 92px;
      overflow:hidden;
    }
    .cardBtn:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(25,20,40,.10); }
    .cardBtn:active{ transform: translateY(0px); }
    .cardTitle{ font-weight:800; }
    .cardDesc{ margin-top:6px; font-size: 12px; color:var(--muted); }

    .locked{
      cursor:not-allowed;
      opacity:.65;
    }
    .lockBadge{
      position:absolute;
      top:10px; right:10px;
      font-size:12px;
      padding: 6px 9px;
      border-radius: 999px;
      border:1px solid rgba(255,93,162,.25);
      background: rgba(255,93,162,.12);
      color: #c62872;
      display:flex; align-items:center; gap:6px;
    }

    .content{ padding: 0 18px 18px; }

    .toolbar{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding: 0 18px 18px;
    }
    .btn{
      border:1px solid rgba(120,120,150,.18);
      background: rgba(255,255,255,.75);
      color: var(--btnInk);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      box-shadow: 0 10px 20px rgba(25,20,40,.08);
      transition: transform .12s ease, box-shadow .12s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 14px 26px rgba(25,20,40,.10); }
    .btn:active{ transform: translateY(0px); }
    .btnPrimary{
      background: linear-gradient(135deg, rgba(255,93,162,.18), rgba(124,92,255,.16));
      border-color: rgba(255,93,162,.22);
    }

    .paper{
      border:1px solid rgba(120,120,150,.16);
      background:
        linear-gradient(180deg, rgba(255,255,255,.88), rgba(255,255,255,.78)),
        repeating-linear-gradient(
          0deg,
          rgba(255,93,162,.08) 0px,
          rgba(255,93,162,.08) 1px,
          transparent 1px,
          transparent 26px
        );
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 18px 40px rgba(25,20,40,.10);
      position:relative;
      overflow:hidden;
    }
    .paper::before{
      content:"";
      position:absolute; inset:-40px -40px auto auto;
      width:140px; height:140px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(255,93,162,.18), transparent 60%);
      transform: rotate(12deg);
    }
    .paper::after{
      content:"";
      position:absolute; inset:auto auto -60px -60px;
      width:180px; height:180px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(124,92,255,.16), transparent 60%);
      transform: rotate(-8deg);
    }
    .paperInner{ position:relative; z-index:1; }
    .typed{
      white-space:pre-wrap;
      line-height:1.55;
      font-size: 14px;
      color: #2b2b33;
    }
    .signature{
      margin-top: 12px;
      font-weight: 800;
      color: rgba(43,43,51,.88);
      white-space:pre-wrap;
    }

    /* Fotos */
    .masonry{
      columns: 2 260px;
      column-gap: 12px;
    }
    .photoCard{
      break-inside: avoid;
      margin: 0 0 12px;
      border-radius: 18px;
      overflow:hidden;
      border: 1px solid rgba(120,120,150,.16);
      background: rgba(255,255,255,.76);
      box-shadow: 0 18px 40px rgba(25,20,40,.10);
      position:relative;
      transform: translateZ(0);
    }
    .photoCard img{
      width:100%;
      height:auto;
      display:block;
      transition: transform .45s ease;
      transform-origin: center;
    }
    .photoCard:hover img{ transform: scale(1.03); }
    .photoCard:active img{ transform: scale(1.02); }

    .caption{
      position:absolute;
      left: 10px;
      right: 10px;
      bottom: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.86);
      border:1px solid rgba(120,120,150,.18);
      box-shadow: 0 10px 20px rgba(25,20,40,.10);
      font-size: 13px;
      color: rgba(43,43,51,.92);
      backdrop-filter: blur(10px);
    }

    /* Swipe album (solo mÃ³vil) */
    .swipeWrap{
      display:none;
      border:1px solid rgba(120,120,150,.16);
      background: rgba(255,255,255,.76);
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(25,20,40,.10);
      overflow:hidden;
      position:relative;
      margin-bottom: 12px;
    }
    .swipeImg{
      width:100%;
      height:auto;
      display:block;
      transition: transform .35s ease, opacity .35s ease;
    }
    .swipeCap{
      position:absolute;
      left: 10px;
      right: 10px;
      bottom: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.88);
      border:1px solid rgba(120,120,150,.18);
      box-shadow: 0 10px 20px rgba(25,20,40,.10);
      font-size: 13px;
      backdrop-filter: blur(10px);
    }
    .swipeDots{
      position:absolute;
      top:10px; right:10px;
      display:flex; gap:6px;
      background: rgba(255,255,255,.70);
      border:1px solid rgba(120,120,150,.18);
      padding: 6px 8px;
      border-radius: 999px;
      backdrop-filter: blur(10px);
    }
    .dot{
      width:7px; height:7px; border-radius:50%;
      background: rgba(120,120,150,.35);
    }
    .dot.active{ background: rgba(255,93,162,.80); }

    @media (max-width: 720px){
      .swipeWrap{ display:block; }
      .masonry{ display:none; }
    }

    /* Test */
    .quiz{ display:grid; gap: 12px; }
    .q{
      border:1px solid rgba(120,120,150,.16);
      background: rgba(255,255,255,.76);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 12px 28px rgba(25,20,40,.08);
    }
    .qTitle{
      font-weight: 900;
      margin: 0 0 8px;
      font-size: 14px;
    }
    .opt{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(120,120,150,.18);
      background: rgba(255,255,255,.78);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .12s ease;
      font-size: 13px;
      -webkit-tap-highlight-color: transparent;
    }
    .chip:hover{ transform: translateY(-1px); }
    .chip.active{
      border-color: rgba(255,93,162,.35);
      background: rgba(255,93,162,.12);
    }

    .notice{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(120,120,150,.16);
      background: rgba(255,255,255,.76);
      box-shadow: 0 12px 28px rgba(25,20,40,.08);
      font-size: 13px;
      color: var(--muted);
    }
    .notice strong{ color: var(--ink); }

    /* Pregunta */
    .askBox{
      border:1px solid rgba(120,120,150,.16);
      background: rgba(255,255,255,.78);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 40px rgba(25,20,40,.10);
      position:relative;
      overflow:hidden;
    }
    .askTitle{
      margin:0;
      font-size: 18px;
      font-weight: 1000;
      letter-spacing:.2px;
    }
    .askSub{
      margin: 6px 0 12px;
      color: var(--muted);
      font-size: 13px;
    }
    .askBtns{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      position:relative;
      min-height: 64px;
    }
    .yesBtn{
      background: linear-gradient(135deg, rgba(255,93,162,.20), rgba(124,92,255,.18));
      border-color: rgba(255,93,162,.25);
      font-weight: 900;
    }
    .noBtn{ position:relative; }

    .result{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(120,120,150,.16);
      background: rgba(255,255,255,.78);
      box-shadow: 0 12px 28px rgba(25,20,40,.08);
      font-size: 14px;
    }

    /* Panel derecho */
    .side{ padding: 16px 16px 18px; }
    .side h3{ margin:0; font-size: 16px; }
    .side p{ margin:6px 0 0; color: var(--muted); font-size: 13px; }
    .kv{ margin-top: 10px; display:grid; gap: 10px; }
    .kvRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding: 10px 12px;
      border-radius: 16px;
      border: 1px solid rgba(120,120,150,.16);
      background: rgba(255,255,255,.72);
      box-shadow: 0 12px 28px rgba(25,20,40,.08);
    }
    .tag{
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border:1px solid rgba(120,120,150,.16);
      background: rgba(255,255,255,.72);
      color: rgba(43,43,51,.86);
      display:inline-flex; gap:6px; align-items:center;
    }
    .tag.good{
      border-color: rgba(23,178,106,.25);
      background: rgba(23,178,106,.10);
      color: #0d7b45;
      font-weight: 800;
    }
    .tag.lock{
      border-color: rgba(255,176,32,.28);
      background: rgba(255,176,32,.12);
      color: #8a5a00;
      font-weight: 800;
    }

    .small{
      font-size:12px;
      color: var(--muted);
      margin-top: 10px;
      line-height:1.4;
    }
  </style>
</head>

<body>
  <div class="bgPhoto"></div>
  <div class="bgOverlay"></div>
  <div class="heartsLayer" id="heartsLayer" aria-hidden="true"></div>
  <div class="confettiLayer" id="confettiLayer" aria-hidden="true"></div>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="tag">ğŸ’— <strong>para Saharaim</strong></div>
        <div class="tag">âœ¨ hecho por Sergio</div>
      </div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
        <div class="pill" id="musicToggle" title="Prende / apaga mÃºsica">ğŸµ <span id="musicLabel">MÃºsica: OFF</span></div>
        <div class="pill" id="heartsToggle" title="Prende / apaga corazones">ğŸ’ <span id="heartsLabel">Corazones: ON</span></div>
        <div class="pill" id="confettiBtn" title="Confeti">ğŸ‰ Confeti</div>
        <div class="pill" id="copyLink" title="Copiar link">ğŸ”— Copiar link</div>
        <div class="pill" id="resetBtn" title="Borrar progreso">ğŸ§¼ Reset</div>
      </div>
    </div>

    <div class="grid">
      <!-- IZQUIERDA -->
      <div class="panel">
        <div class="panelHeader">
          <h2 id="panelTitle">MenÃº</h2>
          <div class="tag" id="crumb">ğŸ  inicio</div>
        </div>
        <p class="sub" id="panelSub">Todo estÃ¡ hecho para ti âœ¨</p>

        <div id="menuView">
          <div class="menuCards">
            <div class="cardBtn" id="goLetter">
              <div class="cardTitle">ğŸ’Œ Carta</div>
              <div class="cardDesc">Para leerla con calma (y con cariÃ±o).</div>
            </div>

            <div class="cardBtn" id="goPhotos">
              <div class="cardTitle">ğŸ“¸ Fotos</div>
              <div class="cardDesc">Un collage con nuestros momentos.</div>
            </div>

            <div class="cardBtn" id="goQuiz">
              <div class="cardTitle">ğŸ§  Mini test</div>
              <div class="cardDesc">Desbloquea la sorpresa final.</div>
            </div>

            <div class="cardBtn locked" id="goAsk" aria-disabled="true">
              <div class="lockBadge" id="askBadge">ğŸ”’ Bloqueado</div>
              <div class="cardTitle">ğŸ’˜ Pregunta</div>
              <div class="cardDesc" id="askDesc">Se desbloquea con el mini test.</div>
            </div>
          </div>

          <div class="content">
            <div class="notice">
              <strong>Tip:</strong> Completa el mini test para desbloquear la <strong>Pregunta</strong> ğŸ’
            </div>
          </div>
        </div>

        <!-- CARTA -->
        <div id="letterView" style="display:none;">
          <div class="toolbar">
            <div class="btn" id="backHome1">â† MenÃº</div>
            <div class="btn btnPrimary" id="reRead">âœ¨ Releer con efecto</div>
            <div class="btn" id="toQuizFromLetter">ğŸ§  Ir al mini test</div>
          </div>
          <div class="content">
            <div class="paper">
              <div class="paperInner">
                <div class="typed" id="typedLetter"></div>
                <div class="signature" id="letterSignature"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- FOTOS -->
        <div id="photosView" style="display:none;">
          <div class="toolbar">
            <div class="btn" id="backHome2">â† MenÃº</div>
          </div>
          <div class="content">
            <h3 style="margin:0 0 6px; font-size:18px;">Nuestros momentos ğŸ“¸</h3>
            <p style="margin:0 0 12px; color:var(--muted); font-size:13px;">Un collageâ€¦ pero con estilito, obvio ğŸ˜Œâœ¨</p>

            <!-- Swipe (mÃ³vil) -->
            <div class="swipeWrap" id="swipeWrap" aria-label="Ãlbum deslizable">
              <img class="swipeImg" id="swipeImg" alt="foto" />
              <div class="swipeCap" id="swipeCap"></div>
              <div class="swipeDots" id="swipeDots"></div>
            </div>

            <!-- Desktop masonry -->
            <div class="masonry" id="masonry"></div>
          </div>
        </div>

        <!-- QUIZ -->
        <div id="quizView" style="display:none;">
          <div class="toolbar">
            <div class="btn" id="backHome3">â† MenÃº</div>
          </div>

          <div class="content">
            <h3 style="margin:0 0 10px; font-size:18px;">Mini test ğŸ§ ğŸ’</h3>

            <div class="quiz" id="quizWrap"></div>

            <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px;">
              <div class="btn btnPrimary" id="submitQuiz">âœ… Enviar</div>
              <div class="btn" id="clearQuiz">ğŸ§½ Limpiar respuestas</div>
            </div>

            <div class="result" id="quizResult" style="display:none;"></div>
          </div>
        </div>

        <!-- PREGUNTA -->
        <div id="askView" style="display:none;">
          <div class="toolbar">
            <div class="btn" id="backHome4">â† MenÃº</div>
          </div>

          <div class="content">
            <div class="askBox">
              <h3 class="askTitle">Â¿Quieres ser mi San ValentÃ­n? ğŸ’˜ğŸ¥º</h3>
              <p class="askSub">Prometo cuidarte bonitoâ€¦ y darte besitos extra cuando estÃ©s enojada ğŸ˜ŒğŸ’—</p>

              <div class="askBtns" id="askBtns">
                <div class="btn yesBtn" id="yesBtn">ğŸ’— SÃ­</div>
                <div class="btn noBtn" id="noBtn">No</div>
              </div>

              <div class="result" id="askResult" style="display:none;"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- DERECHA -->
      <div class="panel">
        <div class="side">
          <h3>Controles</h3>
          <p>Todo pensado para celular ğŸ“±</p>

          <div class="kv">
            <div class="kvRow">
              <div>ğŸµ MÃºsica</div>
              <div class="tag" id="musicStateTag">OFF</div>
            </div>
            <div class="kvRow">
              <div>ğŸ’ Corazones</div>
              <div class="tag good" id="heartsStateTag">ON</div>
            </div>
            <div class="kvRow">
              <div>ğŸ‰ Confeti</div>
              <div class="tag">1 toque</div>
            </div>
            <div class="kvRow">
              <div>ğŸ”— Copiar link</div>
              <div class="tag">1 toque</div>
            </div>
            <div class="kvRow">
              <div>ğŸ§¼ Reset</div>
              <div class="tag">borra progreso</div>
            </div>
            <div class="kvRow">
              <div>Estado</div>
              <div class="tag lock" id="lockTag">Pregunta: bloqueada</div>
            </div>
          </div>

          <div class="small">
            * Si algo se siente raro, prueba â€œResetâ€ ğŸ˜Œ  
            (pero deberÃ­a estar bien fino ğŸ’—)
          </div>
        </div>
      </div>

    </div>
  </div>

  <audio id="bgMusic" preload="auto" loop>
    <source src="assets/photos/music.mp3" type="audio/mpeg" />
  </audio>

  <script>
    /***********************
     * CONFIG
     ***********************/
    const STORAGE = {
      quizPassed: "val_quiz_passed_v2",
      musicOn: "val_music_on_v2",
      heartsOn: "val_hearts_on_v2",
      asked: "val_asked_v2",
    };

    // âœ… Carta revisada (misma vibra, nomÃ¡s mÃ¡s limpia)
    const LETTER_TEXT = `Holi mi amor, mi princesa, mi niÃ±a hermosa, mi todo; te dedico esta pequeÃ±a cartita con todo mi corazÃ³n.

Quiero que sepas que haces mis dÃ­as mejores. TambiÃ©n quiero decirte que me haces muy feliz. Me gusta lo que hacemos juntos, lo que estamos logrando juntos, las visiones que tenemos juntosâ€¦ y hasta las veces que no estamos de acuerdo.

Soy muy feliz a tu lado. La verdad, nunca quiero irme de esto; estoy muy seguro. Quiero que sepas que tienes mi lealtad y mi fidelidad.

Me encanta tu sonrisa, tus ojos, la manera en que me vesâ€¦ incluso cuando estÃ¡s enojada o de mal humor jajs. Muchas cosas podrÃ­a decirte, pero no lo quiero hacer muy largo; solo espero que te guste. <3

Quiero que sepas tambiÃ©n que eres el amor de mi vida y te amo mucho, como no tienes idea, mi amor. Siempre quiero estar junto a ti: aun cuando no nos entendamos, aun en nuestros malos ratos, y claroâ€¦ aÃºn mÃ¡s en nuestros mejores momentos.

De verdad, contigo estoy muy seguro de todo y de las cosas que quiero hacer a tu lado. Con mucho amor te hago esta carta: no solo de labios, sino de corazÃ³n, y con muchÃ­simo amor, solo para ti, mi vida.

QuerÃ­a hacerte algo diferenteâ€¦ algo muy â€œyoâ€, pero totalmente â€œtÃºâ€.

Gracias por estar conmigo, por quererme como soy, y por hacer mis dÃ­as mÃ¡s bonitos.

Me encantas. Me inspiras. Y me haces sentir en casa.`;

    const LETTER_SIGNATURE = `Con mucho cariÃ±o y amor,
tu hombre que te ama, Sergio ğŸ’— (si no eres tÃº, entonces, no lo darÃ© todo)`;

    // âœ… Textos de fotos (emojis â€œsegurosâ€ para que se vean bien)
    const PHOTOS = [
      { src: "assets/photos/01.jpeg", caption: "ğŸ˜‚ğŸ’— Los mejores momentos son cuando nos reÃ­mos juntos" },
      { src: "assets/photos/02.png",  caption: "ğŸï¸ğŸ”¥ La mejor biker" },
      { src: "assets/photos/03.jpeg", caption: "ğŸ«‚ğŸ’ Me gusta cuando me abrazas" },
      { src: "assets/photos/04.jpeg", caption: "ğŸ’—âœ¨ Mi copilota <3" }, /* quitamos emoji raro para que SIEMPRE se vea */
      { src: "assets/photos/05.png",  caption: "ğŸ§¥ğŸ’˜ Bonitos outfits" },
      { src: "assets/photos/06.jpeg", caption: "ğŸ˜ğŸŒ¸ Enamorado de tu hermosa carita!" , optional:true },
      { src: "assets/photos/07.jpeg", caption: "âœ¨ğŸ’– Me cautiva tu belleza" , optional:true },
    ];

    const QUIZ = [
      { q: "Â¿QuÃ© prefiero hacer?", options: ["Ir al gym", "Ir a la escuela", "Jugar videojuegos"], correct: "Ir al gym" },
      { q: "Â¿QuÃ© estilo de moto prefiero?", options: ["Naked", "Deportiva", "Dos tiempos"], correct: "Naked" },
      { q: "Â¿Me amas?", options: ["SÃ­", "No"], correct: "SÃ­" }
    ];

    /***********************
     * Helpers
     ***********************/
    const $ = (id) => document.getElementById(id);
    const save = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    const load = (k, fallback=null) => {
      try{
        const v = localStorage.getItem(k);
        return v===null ? fallback : JSON.parse(v);
      }catch{ return fallback; }
    };

    function show(view){
      const views = ["menuView","letterView","photosView","quizView","askView"];
      views.forEach(v => $(v).style.display = (v===view ? "" : "none"));

      const map = {
        menuView: "ğŸ  inicio",
        letterView: "ğŸ’Œ carta",
        photosView: "ğŸ“¸ fotos",
        quizView: "ğŸ§  mini test",
        askView: "ğŸ’˜ pregunta",
      };
      $("crumb").textContent = map[view] || "ğŸ  inicio";

      const titleMap = {
        menuView: ["MenÃº","Todo estÃ¡ hecho para ti âœ¨"],
        letterView: ["Carta","Una cartita escrita con todo el corazÃ³n ğŸ’—"],
        photosView: ["Fotos","Un collage con nuestros momentos."],
        quizView: ["Mini test","Completa esto y desbloqueas la sorpresa final ğŸ’˜"],
        askView: ["Pregunta","Okâ€¦ ahora sÃ­ viene lo importante ğŸ˜ŒğŸ’—"],
      };
      const [t,s] = titleMap[view] || ["MenÃº","Todo estÃ¡ hecho para ti âœ¨"];
      $("panelTitle").textContent = t;
      $("panelSub").textContent = s;
    }

    /***********************
     * Carta: typing (FIX firma â€œantes de tiempoâ€)
     ***********************/
    let typingToken = 0;
    let typingTimer = null;

    function typeText(el, text, ms=10, token){
      if(typingTimer) clearInterval(typingTimer);
      el.textContent = "";
      let i=0;

      typingTimer = setInterval(() => {
        // si alguien volviÃ³ a presionar â€œreleerâ€, este token queda viejo y se corta
        if(token !== typingToken){
          clearInterval(typingTimer);
          typingTimer = null;
          return;
        }
        el.textContent += text[i] || "";
        i++;
        if(i >= text.length){
          clearInterval(typingTimer);
          typingTimer = null;
          // âœ… firma SOLO al finalizar (y solo si el token sigue siendo el mismo)
          if(token === typingToken){
            $("letterSignature").textContent = LETTER_SIGNATURE;
          }
        }
      }, ms);
    }

    function renderLetter(withEffect=true){
      // nueva â€œsesiÃ³nâ€
      typingToken++;
      const token = typingToken;

      const el = $("typedLetter");
      const sig = $("letterSignature");
      sig.textContent = "";

      if(withEffect){
        typeText(el, LETTER_TEXT, 10, token);
      }else{
        if(typingTimer) clearInterval(typingTimer);
        typingTimer = null;
        el.textContent = LETTER_TEXT;
        sig.textContent = LETTER_SIGNATURE;
      }
    }

    /***********************
     * Fotos
     ***********************/
    function renderPhotos(){
      const wrap = $("masonry");
      wrap.innerHTML = "";
      initSwipeAlbum();

      PHOTOS.forEach(p => {
        const card = document.createElement("div");
        card.className = "photoCard";

        const img = document.createElement("img");
        img.src = p.src;
        img.alt = "foto";
        img.loading = "lazy";
        img.onerror = () => {
          if(p.optional){ card.remove(); }
          else { card.remove(); }
        };

        const cap = document.createElement("div");
        cap.className = "caption";
        cap.textContent = p.caption;

        card.appendChild(img);
        card.appendChild(cap);
        wrap.appendChild(card);
      });
    }

    function availablePhotos(){
      return PHOTOS.slice();
    }

    function initSwipeAlbum(){
      const list = availablePhotos();
      const swipeWrap = $("swipeWrap");
      const img = $("swipeImg");
      const cap = $("swipeCap");
      const dots = $("swipeDots");

      let idx = 0;

      function renderDots(){
        dots.innerHTML = "";
        list.forEach((_, i) => {
          const d = document.createElement("div");
          d.className = "dot" + (i===idx ? " active" : "");
          dots.appendChild(d);
        });
      }

      function setSlide(nextIdx, dir=1){
        idx = (nextIdx + list.length) % list.length;
        img.style.opacity = "0";
        img.style.transform = `translateX(${dir*14}px) scale(1.01)`;
        setTimeout(() => {
          img.src = list[idx].src;
          cap.textContent = list[idx].caption;
          renderDots();
          img.style.opacity = "1";
          img.style.transform = "translateX(0px) scale(1.00)";
        }, 140);
      }

      img.src = list[0].src;
      cap.textContent = list[0].caption;
      renderDots();

      let startX = 0, startY = 0, moved = false;

      swipeWrap.ontouchstart = (e) => {
        const t = e.touches[0];
        startX = t.clientX;
        startY = t.clientY;
        moved = false;
      };

      swipeWrap.ontouchmove = (e) => {
        const t = e.touches[0];
        const dx = t.clientX - startX;
        const dy = t.clientY - startY;
        if(Math.abs(dx) > 10 || Math.abs(dy) > 10) moved = true;
      };

      swipeWrap.ontouchend = (e) => {
        if(!moved) return;
        const t = e.changedTouches[0];
        const dx = t.clientX - startX;
        const dy = t.clientY - startY;
        if(Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > 35){
          if(dx < 0) setSlide(idx+1, 1);
          else setSlide(idx-1, -1);
        }
      };

      swipeWrap.onclick = () => setSlide(idx+1, 1);

      img.onerror = () => setSlide(idx+1, 1);
    }

    /***********************
     * Quiz
     ***********************/
    const quizAnswers = {};
    function renderQuiz(){
      const wrap = $("quizWrap");
      wrap.innerHTML = "";
      QUIZ.forEach((item, idx) => {
        const box = document.createElement("div");
        box.className = "q";

        const t = document.createElement("div");
        t.className = "qTitle";
        t.textContent = `${idx+1}. ${item.q}`;

        const opt = document.createElement("div");
        opt.className = "opt";

        item.options.forEach(o => {
          const chip = document.createElement("div");
          chip.className = "chip";
          chip.textContent = o;
          chip.onclick = () => {
            quizAnswers[idx] = o;
            [...opt.children].forEach(c => c.classList.remove("active"));
            chip.classList.add("active");
          };
          opt.appendChild(chip);
        });

        box.appendChild(t);
        box.appendChild(opt);
        wrap.appendChild(box);
      });
    }

    function checkQuizPassed(){
      return !!load(STORAGE.quizPassed, false);
    }

    // âœ… FIX: ahora tambiÃ©n cambia visualmente en el menÃº (no solo â€œControlesâ€)
    function setAskLocked(isLocked){
      const askCard = $("goAsk");
      const lockTag = $("lockTag");
      const badge = $("askBadge");
      const desc = $("askDesc");

      if(isLocked){
        askCard.classList.add("locked");
        askCard.setAttribute("aria-disabled","true");
        badge.style.display = "flex";
        desc.textContent = "Se desbloquea con el mini test.";
        lockTag.textContent = "Pregunta: bloqueada";
        lockTag.className = "tag lock";
      }else{
        askCard.classList.remove("locked");
        askCard.removeAttribute("aria-disabled");
        badge.style.display = "none";
        desc.textContent = "Ya estÃ¡ lista ğŸ’—";
        lockTag.textContent = "Pregunta: desbloqueada";
        lockTag.className = "tag good";
      }
    }

    /***********************
     * Corazones
     ***********************/
    let heartsTimer = null;

    function spawnHeart(){
      const layer = $("heartsLayer");
      const h = document.createElement("div");
      h.className = "heart";
      const hearts = ["ğŸ’—","ğŸ’","ğŸ’–","ğŸ’˜","ğŸ’“","ğŸ’"];
      h.textContent = hearts[Math.floor(Math.random()*hearts.length)];
      const left = Math.random()*100;
      const size = 14 + Math.random()*16;
      const dur = 5 + Math.random()*5;
      const drift = (Math.random()*160 - 80).toFixed(0) + "px";
      const rot = (Math.random()*80 - 40).toFixed(0) + "deg";
      h.style.left = left + "vw";
      h.style.fontSize = size + "px";
      h.style.animationDuration = dur + "s";
      h.style.setProperty("--drift", drift);
      h.style.setProperty("--rot", rot);
      layer.appendChild(h);
      setTimeout(()=>h.remove(), dur*1000 + 1000);
    }

    function setHearts(on){
      save(STORAGE.heartsOn, on);
      $("heartsLabel").textContent = `Corazones: ${on ? "ON" : "OFF"}`;
      $("heartsStateTag").textContent = on ? "ON" : "OFF";
      $("heartsStateTag").className = on ? "tag good" : "tag";
      const layer = $("heartsLayer");
      layer.style.display = on ? "block" : "none";
      if(heartsTimer) { clearInterval(heartsTimer); heartsTimer=null; }
      if(on){
        for(let i=0;i<10;i++) setTimeout(spawnHeart, i*80);
        heartsTimer = setInterval(spawnHeart, 420);
      }
    }

    /***********************
     * Confeti
     ***********************/
    function popConfetti(){
      const layer = $("confettiLayer");
      const emojis = ["ğŸ‰","âœ¨","ğŸ’–","ğŸ’—","ğŸ’","ğŸŒ¸","ğŸ’˜"];
      const burst = 32;

      for(let i=0;i<burst;i++){
        const c = document.createElement("div");
        c.className = "confetti";
        c.textContent = emojis[Math.floor(Math.random()*emojis.length)];
        const left = Math.random()*100;
        const size = 14 + Math.random()*16;
        const dur = 2.8 + Math.random()*2.2;
        const drift = (Math.random()*260 - 130).toFixed(0) + "px";
        const rot = (Math.random()*220 - 110).toFixed(0) + "deg";
        c.style.left = left + "vw";
        c.style.fontSize = size + "px";
        c.style.animationDuration = dur + "s";
        c.style.setProperty("--drift", drift);
        c.style.setProperty("--rot", rot);
        layer.appendChild(c);
        setTimeout(()=>c.remove(), dur*1000 + 600);
      }
    }

    /***********************
     * MÃºsica
     ***********************/
    async function setMusic(on){
      save(STORAGE.musicOn, on);
      $("musicLabel").textContent = `MÃºsica: ${on ? "ON" : "OFF"}`;
      $("musicStateTag").textContent = on ? "ON" : "OFF";
      $("musicStateTag").className = on ? "tag good" : "tag";
      const audio = $("bgMusic");
      try{
        if(on){
          await audio.play();
        }else{
          audio.pause();
        }
      }catch(e){
        save(STORAGE.musicOn, false);
        $("musicLabel").textContent = "MÃºsica: OFF";
        $("musicStateTag").textContent = "OFF";
        $("musicStateTag").className = "tag";
      }
    }

    /***********************
     * Pregunta (SÃ­/No)
     ***********************/
    function initAsk(){
      const asked = load(STORAGE.asked, false);
      const res = $("askResult");
      if(asked){
        res.style.display = "";
        res.innerHTML = "ğŸ’— Ya quedÃ³ guardadoâ€¦ en el corazÃ³n (y en el navegador ğŸ˜Œ).";
      }else{
        res.style.display = "none";
      }

      const noBtn = $("noBtn");
      const askBtns = $("askBtns");

      let dodges = 0;

      function dodge(){
        const box = askBtns.getBoundingClientRect();
        const b = noBtn.getBoundingClientRect();
        const maxX = Math.max(0, box.width - b.width - 6);
        const maxY = Math.max(0, box.height - b.height - 6);
        const x = Math.random() * maxX;
        const y = Math.random() * maxY;
        noBtn.style.position = "absolute";
        noBtn.style.left = x + "px";
        noBtn.style.top = y + "px";
      }

      noBtn.onmouseenter = () => {
        dodges++;
        if(dodges <= 6) dodge();
      };

      noBtn.ontouchstart = (e) => {
        e.preventDefault();
        dodges++;
        dodge();
      };

      noBtn.onclick = () => {
        res.style.display = "";
        res.innerHTML = "Okâ€¦ te dejo pensarlo ğŸ˜ŒğŸ’— (igual te amo).";
      };

      $("yesBtn").onclick = () => {
        save(STORAGE.asked, true);
        res.style.display = "";
        res.innerHTML = "ğŸ’˜ SÃ A TODO. Ya sabÃ­a ğŸ˜ŒğŸ’—âœ¨";
        popConfetti();
        for(let i=0;i<18;i++) setTimeout(spawnHeart, i*70);
      };
    }

    /***********************
     * Copiar link / Reset
     ***********************/
    async function copyLink(){
      const url = window.location.href;
      try{
        await navigator.clipboard.writeText(url);
        $("copyLink").textContent = "âœ… Copiado";
        setTimeout(()=> $("copyLink").textContent = "ğŸ”— Copiar link", 1100);
      }catch{
        prompt("Copia este link:", url);
      }
    }

    function quizResultHide(){
      const box = $("quizResult");
      box.style.display = "none";
      box.textContent = "";
    }

    function hardReset(){
      Object.values(STORAGE).forEach(k => localStorage.removeItem(k));
      quizResultHide();
      setAskLocked(true);
      show("menuView");
      setHearts(true);
      setMusic(false);
      renderLetter(false);
      renderPhotos();
      renderQuiz();
      initAsk();
    }

    /***********************
     * UI wiring
     ***********************/
    $("goLetter").onclick = () => { show("letterView"); renderLetter(true); };
    $("goPhotos").onclick = () => { show("photosView"); };
    $("goQuiz").onclick   = () => { show("quizView"); };
    $("goAsk").onclick    = () => {
      if(checkQuizPassed()){
        show("askView"); initAsk();
      }else{
        show("quizView");
        const box = $("quizResult");
        box.style.display = "";
        box.innerHTML = "ğŸ”’ Primero completa el mini test para desbloquear la pregunta ğŸ’";
      }
    };

    $("backHome1").onclick = () => show("menuView");
    $("backHome2").onclick = () => show("menuView");
    $("backHome3").onclick = () => show("menuView");
    $("backHome4").onclick = () => show("menuView");

    $("reRead").onclick = () => renderLetter(true);
    $("toQuizFromLetter").onclick = () => show("quizView");

    $("submitQuiz").onclick = () => {
      const box = $("quizResult");
      for(let i=0;i<QUIZ.length;i++){
        if(!quizAnswers[i]){
          box.style.display = "";
          box.innerHTML = "Te faltÃ³ contestar algo ğŸ˜Œâœ¨ (elige una opciÃ³n en cada pregunta).";
          return;
        }
      }

      let ok = 0;
      for(let i=0;i<QUIZ.length;i++){
        if(quizAnswers[i] === QUIZ[i].correct) ok++;
      }

      if(ok === QUIZ.length){
        save(STORAGE.quizPassed, true);
        setAskLocked(false);
        box.style.display = "";
        box.innerHTML = "âœ… Perfecto, mi amor ğŸ’— Ya desbloqueaste la Pregunta ğŸ’˜";
        popConfetti();
        for(let i=0;i<14;i++) setTimeout(spawnHeart, i*80);
      }else{
        box.style.display = "";
        box.innerHTML = `Casi ğŸ˜¼ğŸ’ (${ok}/${QUIZ.length} correctas). Intenta otra vez.`;
        save(STORAGE.quizPassed, false);
        setAskLocked(true);
      }
    };

    $("clearQuiz").onclick = () => {
      Object.keys(quizAnswers).forEach(k => delete quizAnswers[k]);
      renderQuiz();
      quizResultHide();
    };

    $("musicToggle").onclick = async () => {
      const now = !!load(STORAGE.musicOn, false);
      await setMusic(!now);
    };
    $("heartsToggle").onclick = () => {
      const now = !!load(STORAGE.heartsOn, true);
      setHearts(!now);
    };

    $("confettiBtn").onclick = popConfetti;

    $("copyLink").onclick = copyLink;
    $("resetBtn").onclick = hardReset;

    /***********************
     * Boot
     ***********************/
    (function boot(){
      show("menuView");
      renderLetter(false);
      renderPhotos();
      renderQuiz();
      setAskLocked(!checkQuizPassed());
      setHearts(load(STORAGE.heartsOn, true));
      setMusic(load(STORAGE.musicOn, false));
      initAsk();
    })();
  </script>
</body>
</html>
