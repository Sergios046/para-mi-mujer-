<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Para Saharaim üíó</title>
  <style>
    :root{
      --bg1:#fff7fb;
      --bg2:#f3edff;
      --card: rgba(255,255,255,.72);
      --card2: rgba(255,255,255,.85);
      --stroke: rgba(140,120,160,.20);
      --text:#2b2433;
      --muted: rgba(43,36,51,.65);
      --shadow: 0 14px 50px rgba(30,18,44,.12);
      --shadow2: 0 10px 30px rgba(30,18,44,.10);
      --r: 22px;
      --r2: 18px;
      --pad: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,168,213,.28), transparent 60%),
        radial-gradient(900px 600px at 80% 15%, rgba(179,151,255,.25), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* ===== Background photo ===== */
    .bg-photo{
      position:fixed; inset:0;
      z-index:-3;
      background-image: url("assets/photos/06.jpeg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: blur(6px) saturate(1.05) contrast(1.03);
      opacity: .35;
      transform: scale(1.03);
    }
    .bg-overlay{
      position:fixed; inset:0; z-index:-2;
      background: linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.78));
      pointer-events:none;
    }

    /* ===== Floating hearts ===== */
    .hearts-layer{
      position:fixed; inset:0; z-index:-1;
      pointer-events:none;
      overflow:hidden;
    }
    .heart{
      position:absolute;
      font-size: 18px;
      opacity:.0;
      transform: translateY(30px) scale(1);
      animation: floatUp linear forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.10));
    }
    @keyframes floatUp{
      0%{ opacity:0; transform: translateY(30px) scale(.95); }
      12%{ opacity:.95; }
      100%{ opacity:0; transform: translateY(-110vh) scale(1.1); }
    }

    /* ===== Top bar ===== */
    .topbar{
      max-width: 1100px;
      margin: 18px auto 0;
      padding: 0 14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .pill .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(140,120,160,.16);
      font-size: 13px;
      color: rgba(43,36,51,.78);
      white-space: nowrap;
    }
    .top-actions{
      display:flex; gap:10px; flex-wrap: wrap;
      justify-content:flex-end;
    }
    .btn{
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      font-weight: 600;
      color: rgba(43,36,51,.82);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 26px rgba(30,18,44,.14); }
    .btn:active{ transform: translateY(0px) scale(.98); }
    .btn .state{
      font-size: 12px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(90,160,120,.25);
      background: rgba(90,200,140,.12);
      color: rgba(30,120,70,.95);
    }
    .btn.off .state{
      border-color: rgba(180,110,140,.25);
      background: rgba(255,120,170,.10);
      color: rgba(160,60,110,.95);
    }

    /* ===== Layout ===== */
    .wrap{
      max-width:1100px;
      margin: 14px auto 36px;
      padding: 0 14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding: var(--pad);
    }
    .card h2{
      margin: 0 0 2px 0;
      font-size: 18px;
      letter-spacing: .2px;
    }
    .sub{
      margin: 0 0 14px 0;
      color: var(--muted);
      font-size: 13px;
    }

    /* ===== Progress ===== */
    .progress-wrap{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(140,120,160,.14);
    }
    .progress-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .prog-title{
      font-weight: 800;
      letter-spacing:.2px;
      font-size: 13px;
      color: rgba(43,36,51,.82);
    }
    .prog-percent{
      font-size: 12px;
      color: rgba(43,36,51,.62);
      font-weight: 700;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(140,120,160,.14);
      overflow:hidden;
      border: 1px solid rgba(140,120,160,.10);
    }
    .bar > div{
      height:100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,120,190,.55), rgba(155,125,255,.55));
      transition: width .35s ease;
    }
    .steps{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    @media (max-width: 520px){
      .steps{ grid-template-columns: 1fr 1fr; }
    }
    .step{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(140,120,160,.14);
      background: rgba(255,255,255,.55);
      font-size: 12.5px;
      color: rgba(43,36,51,.70);
      font-weight: 700;
    }
    .dot{
      width: 10px; height: 10px;
      border-radius: 50%;
      background: rgba(140,120,160,.25);
      border: 1px solid rgba(140,120,160,.15);
      flex: 0 0 auto;
    }
    .step.done{
      background: rgba(90,200,140,.10);
      border-color: rgba(90,200,140,.20);
      color: rgba(35,120,75,.88);
    }
    .step.done .dot{
      background: rgba(90,200,140,.65);
      border-color: rgba(90,200,140,.25);
    }

    /* ===== Menu cards ===== */
    .menu-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 680px){
      .menu-grid{ grid-template-columns: 1fr 1fr; }
    }
    .tile{
      position:relative;
      padding: 14px 12px;
      border-radius: 18px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.64);
      box-shadow: 0 10px 24px rgba(30,18,44,.08);
      cursor:pointer;
      transition: transform .16s ease, box-shadow .16s ease, background .16s ease;
      min-height: 86px;
      overflow:hidden;
    }
    .tile:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(30,18,44,.10); }
    .tile:active{ transform: translateY(0px) scale(.99); }
    .tile .t-title{
      display:flex; gap:8px; align-items:center;
      font-weight: 900;
      margin-bottom: 6px;
    }
    .tile .t-desc{
      font-size: 12px;
      color: rgba(43,36,51,.62);
      font-weight: 600;
      line-height: 1.25;
    }
    .tile.locked{
      opacity: .62;
      cursor:not-allowed;
      filter: grayscale(.08);
    }
    .tile.locked::after{
      content:"üîí Bloqueado";
      position:absolute;
      top: 10px;
      right: 10px;
      font-size: 11px;
      font-weight: 800;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(140,120,160,.16);
      color: rgba(160,60,110,.78);
    }

    /* ===== Section header ===== */
    .section-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .crumb{
      display:flex; gap:10px; align-items:center;
      font-weight: 900;
      font-size: 15px;
    }
    .back{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.62);
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
      transition: transform .15s ease;
    }
    .back:hover{ transform: translateY(-1px); }
    .hint-badge{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(155,125,255,.35);
      background: rgba(155,125,255,.10);
      color: rgba(80,60,140,.88);
      font-weight: 800;
    }

    /* ===== Letter card ===== */
    .paper{
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(140,120,160,.16);
      border-radius: 20px;
      padding: 16px 16px 14px 16px;
      box-shadow: 0 10px 24px rgba(30,18,44,.08);
      position:relative;
      overflow:hidden;
    }
    .paper::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 120px at 20% 12%, rgba(255,170,210,.28), transparent 55%),
        radial-gradient(600px 120px at 80% 18%, rgba(175,150,255,.25), transparent 55%),
        linear-gradient(90deg, rgba(240,230,255,.25), rgba(255,230,245,.22));
      opacity:.9;
      z-index:0;
    }
    .paper::after{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(120,90,160,.06) 0px,
        rgba(120,90,160,.06) 1px,
        transparent 1px,
        transparent 28px
      );
      opacity:.65;
      z-index:0;
      mix-blend-mode:multiply;
    }
    .paper-inner{
      position:relative;
      z-index:1;
      white-space:pre-wrap;
      line-height: 1.45;
      font-size: 14px;
      color: rgba(43,36,51,.88);
      font-weight: 650;
    }
    .paper-sign{
      margin-top: 10px;
      font-weight: 900;
      color: rgba(43,36,51,.82);
    }
    .letter-actions{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }
    .mini-btn{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.74);
      font-weight: 900;
      font-size: 13px;
      transition: transform .15s ease;
    }
    .mini-btn:hover{ transform: translateY(-1px); }
    .mini-btn:active{ transform: translateY(0px) scale(.99); }

    /* Surprise button at end */
    .surprise{
      display:none;
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,120,190,.25);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 24px rgba(30,18,44,.08);
    }
    .surprise .s-title{
      font-weight: 1000;
      margin-bottom: 6px;
    }
    .surprise .s-text{
      color: rgba(43,36,51,.70);
      font-weight: 700;
      font-size: 13px;
      line-height: 1.3;
    }

    /* ===== Photos collage ===== */
    .collage{
      display:grid;
      grid-template-columns: 1.25fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 680px){
      .collage{ grid-template-columns: 1fr; }
    }
    .col{
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .photo{
      position:relative;
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.55);
      box-shadow: 0 12px 28px rgba(30,18,44,.10);
      transform: translateZ(0);
    }
    .photo img{
      width:100%;
      height:100%;
      object-fit: cover;
      display:block;
      transform: scale(1.02);
      transition: transform .22s ease;
    }
    .photo:hover img{ transform: scale(1.05); }
    .cap{
      position:absolute;
      left: 10px;
      right: 10px;
      bottom: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(140,120,160,.16);
      color: rgba(43,36,51,.80);
      font-weight: 900;
      font-size: 13px;
      line-height: 1.25;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 22px rgba(30,18,44,.10);
    }
    .tap-hint{
      font-size: 12px;
      color: rgba(43,36,51,.55);
      margin-top: 12px;
      font-weight: 700;
    }

    /* Heart pop on photo tap */
    .pop-heart{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%) scale(.6);
      font-size: 52px;
      opacity:0;
      pointer-events:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.18));
      animation: popHeart .65s ease forwards;
    }
    @keyframes popHeart{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.5); }
      25%{ opacity:1; transform: translate(-50%,-55%) scale(1.05); }
      100%{ opacity:0; transform: translate(-50%,-80%) scale(1.2); }
    }

    /* ===== Mini test ===== */
    .quiz{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .q{
      border-radius: 18px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.65);
      padding: 12px;
      box-shadow: 0 10px 22px rgba(30,18,44,.08);
    }
    .q h3{
      margin: 0 0 10px 0;
      font-size: 14px;
      font-weight: 950;
      color: rgba(43,36,51,.86);
    }
    .opts{
      display:flex;
      gap: 8px;
      flex-wrap:wrap;
    }
    .opt{
      cursor:pointer;
      border-radius: 999px;
      padding: 10px 12px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.74);
      font-weight: 900;
      font-size: 13px;
      transition: transform .12s ease;
    }
    .opt:hover{ transform: translateY(-1px); }
    .opt.selected{
      border-color: rgba(155,125,255,.35);
      background: rgba(155,125,255,.10);
      color: rgba(80,60,140,.92);
    }
    .quiz-actions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 4px;
    }
    .toast{
      margin-top: 10px;
      padding: 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.68);
      font-weight: 900;
      color: rgba(43,36,51,.78);
      display:none;
    }
    .toast.good{
      border-color: rgba(90,200,140,.22);
      background: rgba(90,200,140,.10);
      color: rgba(35,120,75,.88);
    }
    .toast.bad{
      border-color: rgba(255,120,170,.22);
      background: rgba(255,120,170,.10);
      color: rgba(160,60,110,.90);
    }

    /* ===== Final question ===== */
    .final{
      margin-top: 10px;
      padding: 14px;
      border-radius: 20px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.68);
      box-shadow: 0 12px 28px rgba(30,18,44,.10);
    }
    .final h3{
      margin: 0 0 6px 0;
      font-size: 16px;
      font-weight: 1000;
    }
    .final p{
      margin: 0 0 14px 0;
      color: rgba(43,36,51,.65);
      font-weight: 650;
      font-size: 13px;
    }
    .yn{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
    }
    .yes, .no{
      cursor:pointer;
      border-radius: 999px;
      padding: 12px 14px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.78);
      font-weight: 1000;
      font-size: 14px;
      transition: transform .15s ease;
      position:relative;
    }
    .yes:hover{ transform: translateY(-1px); }
    .no:hover{ transform: translateY(-1px); }
    .final-msg{
      margin-top: 12px;
      font-weight: 1000;
      display:none;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(90,200,140,.22);
      background: rgba(90,200,140,.10);
      color: rgba(35,120,75,.88);
    }

    /* ===== Right controls panel ===== */
    .controls .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding: 12px 12px;
      border-radius: 18px;
      border: 1px solid rgba(140,120,160,.14);
      background: rgba(255,255,255,.62);
      margin-top: 10px;
    }
    .controls .label{
      display:flex; align-items:center; gap:10px;
      font-weight: 950;
      color: rgba(43,36,51,.82);
    }
    .toggle{
      width: 54px;
      height: 30px;
      border-radius: 999px;
      background: rgba(140,120,160,.16);
      border: 1px solid rgba(140,120,160,.12);
      position:relative;
      cursor:pointer;
      flex: 0 0 auto;
      transition: background .2s ease;
    }
    .knob{
      width: 26px; height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(140,120,160,.16);
      position:absolute;
      top: 1px; left: 1px;
      transition: left .2s ease;
      box-shadow: 0 10px 20px rgba(30,18,44,.10);
    }
    .toggle.on{
      background: rgba(90,200,140,.28);
      border-color: rgba(90,200,140,.22);
    }
    .toggle.on .knob{ left: 27px; }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-weight: 950;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(140,120,160,.14);
      background: rgba(255,255,255,.62);
      color: rgba(43,36,51,.74);
      white-space: nowrap;
    }
    .status-pill.good{
      border-color: rgba(90,200,140,.22);
      background: rgba(90,200,140,.10);
      color: rgba(35,120,75,.88);
    }
    .status-pill.bad{
      border-color: rgba(255,120,170,.22);
      background: rgba(255,120,170,.10);
      color: rgba(160,60,110,.90);
    }

    /* ===== Fullscreen mode ===== */
    .fullscreen .controls-panel{ display:none; }
    .controls-panel{ }
    .fullscreen .wrap{ grid-template-columns: 1fr; }
    .fullscreen .topbar{ max-width: 980px; }
    .fullscreen .card{ box-shadow: 0 18px 60px rgba(30,18,44,.14); }

    /* small animation */
    .fade-in{
      animation: fadeIn .25s ease both;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* reduce motion */
    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="bg-photo"></div>
  <div class="bg-overlay"></div>
  <div class="hearts-layer" id="heartsLayer"></div>

  <div class="topbar">
    <div class="pill">
      <div class="tag">üíó <b>para Saharaim</b></div>
      <div class="tag">‚ú® hecho por Sergio</div>
    </div>

    <div class="top-actions">
      <div class="btn" id="btnMusic" title="M√∫sica">
        üéµ M√∫sica <span class="state" id="musicState">OFF</span>
      </div>
      <div class="btn" id="btnHearts" title="Corazones">
        üíû Corazones <span class="state" id="heartsState">ON</span>
      </div>
      <div class="btn" id="btnFullscreen" title="Pantalla completa">
        üì± Pantalla <span class="state" id="fsState">FULL</span>
      </div>
      <div class="btn" id="btnCopy" title="Copiar link">
        üîó Copiar link
      </div>
      <div class="btn off" id="btnReset" title="Reset">
        üßº Reset
      </div>
    </div>
  </div>

  <div class="wrap" id="app">
    <!-- Left main -->
    <div class="card" id="mainCard">
      <div id="view"></div>
    </div>

    <!-- Right controls -->
    <div class="card controls-panel" id="controlsPanel">
      <h2>Controles</h2>
      <p class="sub">Todo pensado para celular üì±</p>

      <div class="row">
        <div class="label">üéµ M√∫sica</div>
        <div class="toggle" id="toggleMusic"><div class="knob"></div></div>
      </div>

      <div class="row">
        <div class="label">üíû Corazones</div>
        <div class="toggle on" id="toggleHearts"><div class="knob"></div></div>
      </div>

      <div class="row">
        <div class="label">üîó Copiar link</div>
        <div class="status-pill">1 toque</div>
      </div>

      <div class="row">
        <div class="label">üßº Reset</div>
        <div class="status-pill bad">borra progreso</div>
      </div>

      <div class="row" style="justify-content:space-between;">
        <div class="label">üìå Estado</div>
        <div id="statusPill" class="status-pill bad">Pregunta: bloqueada</div>
      </div>

      <div class="progress-wrap" style="margin-top:12px;">
        <div class="progress-top">
          <div class="prog-title">Progreso üíó</div>
          <div class="prog-percent" id="progPercent">0%</div>
        </div>
        <div class="bar"><div id="progBar"></div></div>
        <div class="steps">
          <div class="step" id="sLetter"><div class="dot"></div> Carta</div>
          <div class="step" id="sPhotos"><div class="dot"></div> Fotos</div>
          <div class="step" id="sQuiz"><div class="dot"></div> Mini test</div>
          <div class="step" id="sAsk"><div class="dot"></div> Pregunta</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Audio -->
  <audio id="audio" preload="auto" loop>
    <source src="assets/photos/music.mp3" type="audio/mpeg">
  </audio>

  <script>
    /* =============================
      State (localStorage)
    ============================== */
    const LS_KEY = "valentine_state_v3";
    const defaultState = {
      visited: { home:true, letter:false, photos:false, quiz:false, ask:false },
      quizPassed: false,
      askUnlocked: false,  // unlocked by quiz
      heartsOn: true,
      musicOn: false,
      fullscreen: false
    };

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return structuredClone(defaultState);
        const s = JSON.parse(raw);
        return {
          ...structuredClone(defaultState),
          ...s,
          visited: { ...structuredClone(defaultState.visited), ...(s.visited||{}) }
        };
      }catch{
        return structuredClone(defaultState);
      }
    }
    function saveState(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      updateUIBits();
    }
    function hardReset(){
      localStorage.removeItem(LS_KEY);
      state = structuredClone(defaultState);
      stopTyping(true);
      stopHearts();
      startHearts();
      pauseMusic();
      render("home");
      updateUIBits();
    }

    let state = loadState();

    /* =============================
      Utilities
    ============================== */
    const $ = (id)=>document.getElementById(id);
    const view = $("view");
    const audio = $("audio");

    function safeScrollTop(){
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function emojiForCaption(i){
      // sutil y cute, no saturar
      const list = ["üíû","üòπ","üèçÔ∏è","ü§ç","üß∏","‚ú®","üòΩ","üíó","üì∏","ü•∫"];
      return list[i % list.length];
    }

    /* =============================
      Hearts
    ============================== */
    const heartsLayer = $("heartsLayer");
    let heartsTimer = null;

    function startHearts(){
      if(!state.heartsOn) return;
      if(heartsTimer) return;
      heartsTimer = setInterval(spawnHeart, 450);
    }
    function stopHearts(){
      if(heartsTimer){
        clearInterval(heartsTimer);
        heartsTimer = null;
      }
    }
    function spawnHeart(){
      if(!state.heartsOn) return;
      const heart = document.createElement("div");
      heart.className = "heart";
      const hearts = ["üíó","üíû","üíñ","üíò","‚ù§Ô∏è","üíì"];
      heart.textContent = hearts[Math.floor(Math.random()*hearts.length)];
      const size = 14 + Math.random()*16;
      heart.style.fontSize = size + "px";
      heart.style.left = (Math.random()*100) + "vw";
      heart.style.bottom = (-20 - Math.random()*30) + "px";
      const dur = 6 + Math.random()*5;
      heart.style.animationDuration = dur + "s";
      heart.style.animationDelay = (Math.random()*0.2) + "s";
      heartsLayer.appendChild(heart);
      requestAnimationFrame(()=>{ /* let animation start */ });
      setTimeout(()=> heart.remove(), (dur+1)*1000);
    }

    /* =============================
      Confetti (mini)
    ============================== */
    function confettiBurst(){
      // mini confetti, ligero
      const colors = ["#ff7ac3","#b89bff","#ffd1ea","#9be9c3","#ffe08a"];
      for(let i=0;i<40;i++){
        const p = document.createElement("div");
        p.style.position = "fixed";
        p.style.left = (50 + (Math.random()*30-15)) + "vw";
        p.style.top = (40 + (Math.random()*10-5)) + "vh";
        p.style.width = (6 + Math.random()*6) + "px";
        p.style.height = (6 + Math.random()*10) + "px";
        p.style.background = colors[Math.floor(Math.random()*colors.length)];
        p.style.borderRadius = "3px";
        p.style.opacity = ".95";
        p.style.zIndex = 50;
        p.style.transform = "translate(-50%,-50%) rotate("+(Math.random()*180)+"deg)";
        document.body.appendChild(p);

        const dx = (Math.random()*2-1) * 180;
        const dy = 220 + Math.random()*180;
        const rot = (Math.random()*2-1) * 260;
        const dur = 600 + Math.random()*500;

        p.animate([
          { transform:`translate(-50%,-50%) translate(0,0) rotate(0deg)`, opacity:.95 },
          { transform:`translate(-50%,-50%) translate(${dx}px,${dy}px) rotate(${rot}deg)`, opacity:0 }
        ], { duration: dur, easing:"cubic-bezier(.2,.8,.2,1)" });

        setTimeout(()=>p.remove(), dur+50);
      }
    }

    /* =============================
      Music
    ============================== */
    function playMusic(){
      state.musicOn = true;
      saveState();
      audio.volume = 0.9;
      audio.play().catch(()=>{/* iOS can block until user gesture, but our toggle is a gesture */});
    }
    function pauseMusic(){
      state.musicOn = false;
      saveState();
      audio.pause();
    }
    function toggleMusic(){
      if(state.musicOn) pauseMusic();
      else playMusic();
    }

    /* =============================
      Fullscreen Mode (UI)
    ============================== */
    function toggleFullscreenUI(){
      state.fullscreen = !state.fullscreen;
      saveState();
    }

    /* =============================
      Progress
    ============================== */
    function computeProgress(){
      // 4 steps: visited letter/photos + quizPassed + askUnlocked (or visited ask?) + accepted?
      let done = 0;
      const steps = {
        letter: !!state.visited.letter,
        photos: !!state.visited.photos,
        quiz: !!state.quizPassed,
        ask: !!state.askUnlocked // unlocked means ready; visiting ask will also mark
      };
      done += steps.letter ? 1 : 0;
      done += steps.photos ? 1 : 0;
      done += steps.quiz ? 1 : 0;
      done += steps.ask ? 1 : 0;

      const percent = Math.round((done/4)*100);
      return { steps, done, percent };
    }

    function updateProgressUI(){
      const { steps, percent } = computeProgress();
      $("progBar").style.width = percent + "%";
      $("progPercent").textContent = percent + "%";

      $("sLetter").classList.toggle("done", steps.letter);
      $("sPhotos").classList.toggle("done", steps.photos);
      $("sQuiz").classList.toggle("done", steps.quiz);
      $("sAsk").classList.toggle("done", steps.ask);
    }

    /* =============================
      Menu tiles + routing
    ============================== */
    function render(route){
      safeScrollTop();
      view.innerHTML = "";
      view.classList.remove("fade-in");
      void view.offsetWidth;
      view.classList.add("fade-in");

      if(route === "home") renderHome();
      if(route === "letter") renderLetter();
      if(route === "photos") renderPhotos();
      if(route === "quiz") renderQuiz();
      if(route === "ask") renderAsk();

      updateUIBits();
    }

    function renderHome(){
      state.visited.home = true;
      saveState();

      const askLocked = !state.askUnlocked;

      view.innerHTML = `
        <div class="section-head">
          <div>
            <h2 style="margin:0;">Men√∫</h2>
            <p class="sub" style="margin-top:4px;">Todo est√° hecho para ti ‚ú®</p>
          </div>
          <div class="hint-badge">üè† inicio</div>
        </div>

        <div class="menu-grid">
          <div class="tile" data-go="letter">
            <div class="t-title">üíå Carta</div>
            <div class="t-desc">Para leerla con calma (y con cari√±o).</div>
          </div>
          <div class="tile" data-go="photos">
            <div class="t-title">üì∏ Fotos</div>
            <div class="t-desc">Un collage con nuestros momentos.</div>
          </div>
          <div class="tile" data-go="quiz">
            <div class="t-title">üß† Mini test</div>
            <div class="t-desc">Desbloquea la sorpresa final.</div>
          </div>
          <div class="tile ${askLocked ? "locked" : ""}" data-go="${askLocked ? "" : "ask"}" ${askLocked ? 'title="Se desbloquea con el mini test"' : ""}>
            <div class="t-title">üíò Pregunta</div>
            <div class="t-desc">${askLocked ? "Se desbloquea con el mini test." : "Ya est√° lista para ti üòºüíó"}</div>
          </div>
        </div>

        <div class="progress-wrap" style="margin-top:14px;">
          <div style="font-weight:900; color:rgba(43,36,51,.78);">
            Tip: completa el mini test para desbloquear la <b>Pregunta</b> üíû
          </div>
        </div>
      `;

      view.querySelectorAll("[data-go]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const go = el.getAttribute("data-go");
          if(!go) return;
          render(go);
        });
      });
    }

    /* =============================
      Letter (typing effect)
    ============================== */
    const LETTER_TEXT = `Holi mi amor, mi princesa, mi ni√±a hermosa, mi todo; te dedico esta peque√±a cartita con todo mi coraz√≥n.  

Quiero que sepas que haces mis d√≠as mejores. Tambi√©n quiero decirte que me haces muy feliz. Me gusta lo que hacemos juntos, lo que estamos logrando juntos, las visiones que tenemos juntos‚Ä¶ y tambi√©n hasta por las veces que no estamos de acuerdo.  

Soy muy feliz a tu lado; la verdad, nunca quiero irme de esto‚Ä¶ estoy muy seguro. Quiero que sepas que tienes mi lealtad y mi fidelidad.  

Me encanta tu sonrisa, tus ojos, la manera en que me ves‚Ä¶ incluso cuando est√°s enojada o de mal humor, hshs. Muchas cosas pudiera decirte, pero no lo quiero hacer muy largo‚Ä¶ solo espero que te guste <3  

Quiero que sepas tambi√©n que eres el amor de mi vida y te amo mucho como no tienes idea, mi amor. Siempre quiero estar junto a ti: aun cuando no nos entendamos, aun en nuestros malos ratos‚Ä¶ y claro, a√∫n m√°s en nuestros mejores momentos.  

De verdad, contigo estoy muy seguro de todo, y de las cosas que quiero hacer junto a ti.  

Con mucho amor te hago esta carta. No solo de labios, sino de coraz√≥n‚Ä¶ y con mucho amor, solo para ti, mi vida.  

Quer√≠a hacerte algo diferente‚Ä¶ algo muy ‚Äúyo‚Äù, pero totalmente ‚Äút√∫‚Äù.  

Gracias por estar conmigo, por quererme como soy, y por hacer mis d√≠as m√°s bonitos.  

Me encantas. Me inspiras. Y me haces sentir en casa.`;

    const LETTER_SIGN = `Con mucho cari√±o y amor,
tu hombre que te ama, Sergio üíó
(si no eres t√∫, entonces no lo dar√© todo)`;

    let typingTimer = null;
    let typingToken = 0;

    function stopTyping(clear=false){
      typingToken++;
      if(typingTimer){
        clearInterval(typingTimer);
        typingTimer = null;
      }
      if(clear){
        const el = $("letterBody");
        if(el) el.textContent = "";
      }
    }

    function typeLetter(){
      stopTyping(true);
      const token = ++typingToken;

      const bodyEl = $("letterBody");
      const signEl = $("letterSign");
      const surpriseEl = $("surpriseBox");

      signEl.textContent = "";
      surpriseEl.style.display = "none";

      const full = LETTER_TEXT;
      let i = 0;

      typingTimer = setInterval(()=>{
        if(token !== typingToken){
          clearInterval(typingTimer);
          typingTimer = null;
          return;
        }

        i++;
        bodyEl.textContent = full.slice(0,i);

        if(i >= full.length){
          clearInterval(typingTimer);
          typingTimer = null;
          // sign appears strictly at end (fixes the ‚Äúappears early‚Äù bug)
          signEl.textContent = LETTER_SIGN;
          // reveal surprise
          surpriseEl.style.display = "block";
          state.visited.letter = true;
          saveState();
        }
      }, 14);
    }

    function renderLetter(){
      state.visited.letter = true;
      saveState();

      view.innerHTML = `
        <div class="section-head">
          <div class="crumb">
            <div class="back" id="backHome">‚Üê Men√∫</div>
            <div>Una carta para ti üíå</div>
          </div>
          <div class="hint-badge">carta</div>
        </div>

        <div class="paper">
          <div class="paper-inner" id="letterBody"></div>
          <div class="paper-sign" id="letterSign"></div>

          <div class="surprise" id="surpriseBox">
            <div class="s-title">ü•∫üíó Una cosita m√°s‚Ä¶</div>
            <div class="s-text">T√≥came, porfa. Prometo que es bonito üòΩ‚ú®</div>
            <div style="margin-top:10px;">
              <div class="mini-btn" id="btnSurprise">üéâ Tocar aqu√≠</div>
            </div>
          </div>
        </div>

        <div class="letter-actions">
          <div class="mini-btn" id="btnReread">‚ú® Releer con efecto</div>
          <div class="mini-btn" id="btnGoQuiz">üß† Ir al mini test</div>
        </div>
      `;

      $("backHome").onclick = ()=> render("home");
      $("btnReread").onclick = ()=> typeLetter();
      $("btnGoQuiz").onclick = ()=> render("quiz");
      $("btnSurprise").onclick = ()=>{
        confettiBurst();
        // mini extra message
        const s = $("surpriseBox");
        const t = s.querySelector(".s-text");
        t.textContent = "Te amo much√≠simo. Gracias por existir en mi vida üíóüòΩ";
      };

      // auto start typing once entering
      typeLetter();
    }

    /* =============================
      Photos
    ============================== */
    const photosData = [
      { file:"assets/photos/01.jpeg", cap:`Los mejores momentos son cuando nos re√≠mos juntos ${emojiForCaption(1)}` },
      { file:"assets/photos/02.png",  cap:`La mejor biker üèçÔ∏èüíó` },
      { file:"assets/photos/03.jpeg", cap:`Me gusta cuando me abrazas üß∏ü§ç` },
      { file:"assets/photos/04.jpeg", cap:`Mi copilota <3 üòΩüíû` },
      { file:"assets/photos/05.png",  cap:`Bonitos outfits ‚ú®üíñ` },
      { file:"assets/photos/06.jpeg", cap:`Enamorado de tu hermosa carita! ü•∫üíó` },
      { file:"assets/photos/07.jpeg", cap:`Me cautiva tu belleza üíò‚ú®` }
    ];

    function photoCardHTML(p, h=220){
      return `
        <div class="photo" style="height:${h}px;" data-photo>
          <img src="${p.file}" alt="foto" loading="lazy" />
          <div class="cap">${p.cap}</div>
        </div>
      `;
    }

    function renderPhotos(){
      state.visited.photos = true;
      saveState();

      // layout: left big, then smaller right column, then bottom wide
      view.innerHTML = `
        <div class="section-head">
          <div class="crumb">
            <div class="back" id="backHome">‚Üê Men√∫</div>
            <div>Nuestros momentos üì∏</div>
          </div>
          <div class="hint-badge">fotos</div>
        </div>

        <p class="sub">Un collage‚Ä¶ pero con estilito, obvio üòå</p>

        <div class="collage">
          <div class="col">
            ${photoCardHTML(photosData[0], 320)}
            <div style="display:grid; grid-template-columns: 1fr; gap:12px;">
              ${photoCardHTML(photosData[4], 200)}
            </div>
          </div>

          <div class="col">
            ${photoCardHTML(photosData[1], 200)}
            ${photoCardHTML(photosData[2], 210)}
            ${photoCardHTML(photosData[3], 210)}
          </div>
        </div>

        <div style="margin-top:12px;">
          ${photoCardHTML(photosData[5], 240)}
        </div>
        <div style="margin-top:12px;">
          ${photoCardHTML(photosData[6], 240)}
        </div>

        <div class="tap-hint">Tip: toca cualquier foto para un ‚Äúlike‚Äù r√°pido üíó</div>
      `;

      $("backHome").onclick = ()=> render("home");

      // tap = heart + subtle zoom
      view.querySelectorAll("[data-photo]").forEach(card=>{
        const img = card.querySelector("img");
        const pop = ()=>{
          // small zoom pop
          img.animate([
            { transform:"scale(1.02)" },
            { transform:"scale(1.06)" },
            { transform:"scale(1.02)" }
          ], { duration: 260, easing:"ease-out" });

          const h = document.createElement("div");
          h.className = "pop-heart";
          h.textContent = "üíó";
          card.appendChild(h);
          setTimeout(()=>h.remove(), 700);
        };
        card.addEventListener("click", pop, { passive:true });
      });
    }

    /* =============================
      Quiz
    ============================== */
    const quiz = [
      {
        title: "1) ¬øQu√© prefiero hacer? üòº",
        options: ["Ir al gym üí™", "Ir a la escuela üìö", "Jugar videojuegos üéÆ"],
        correct: 0
      },
      {
        title: "2) ¬øQu√© estilo de moto prefiero? üèçÔ∏è",
        options: ["Naked üòà", "Deportiva üèÅ", "2 tiempos üí®"],
        correct: 0
      },
      {
        title: "3) ¬øMe amas? ü•∫üíó",
        options: ["S√≠ üíû", "No üôÑ"],
        correct: 0
      }
    ];

    function renderQuiz(){
      state.visited.quiz = true;
      saveState();

      view.innerHTML = `
        <div class="section-head">
          <div class="crumb">
            <div class="back" id="backHome">‚Üê Men√∫</div>
            <div>Mini test üß†</div>
          </div>
          <div class="hint-badge">test</div>
        </div>

        <p class="sub">Resp√≥ndelo bien y se desbloquea la sorpresa final üíò</p>

        <div class="quiz" id="quizBox"></div>

        <div class="quiz-actions">
          <div class="mini-btn" id="btnSend">‚úÖ Enviar</div>
          <div class="mini-btn" id="btnResetQuiz">üîÅ Limpiar</div>
        </div>

        <div class="toast" id="toast"></div>
      `;

      $("backHome").onclick = ()=> render("home");

      const box = $("quizBox");
      const selected = new Array(quiz.length).fill(null);

      quiz.forEach((q, qi)=>{
        const qEl = document.createElement("div");
        qEl.className = "q";
        qEl.innerHTML = `
          <h3>${q.title}</h3>
          <div class="opts">
            ${q.options.map((o, oi)=>`<div class="opt" data-q="${qi}" data-o="${oi}">${o}</div>`).join("")}
          </div>
        `;
        box.appendChild(qEl);
      });

      box.querySelectorAll(".opt").forEach(opt=>{
        opt.addEventListener("click", ()=>{
          const qi = Number(opt.getAttribute("data-q"));
          const oi = Number(opt.getAttribute("data-o"));
          selected[qi] = oi;

          // mark selected on that question
          box.querySelectorAll(`.opt[data-q="${qi}"]`).forEach(x=>x.classList.remove("selected"));
          opt.classList.add("selected");
        }, { passive:true });
      });

      $("btnResetQuiz").onclick = ()=>{
        selected.fill(null);
        box.querySelectorAll(".opt").forEach(x=>x.classList.remove("selected"));
        showToast("", "");
      };

      $("btnSend").onclick = ()=>{
        // validate all answered
        for(let i=0;i<selected.length;i++){
          if(selected[i] === null){
            showToast("Te falta una üòº (responde todas)", "bad");
            return;
          }
        }

        // check
        for(let i=0;i<quiz.length;i++){
          if(selected[i] !== quiz[i].correct){
            showToast("Uy no üòπ Intenta otra vez, mi amor üíó", "bad");
            return;
          }
        }

        state.quizPassed = true;
        state.askUnlocked = true;
        saveState();
        confettiBurst();
        showToast("Perfecto ‚úÖ Ya se desbloque√≥ la Pregunta üíò", "good");

        // go to menu after a sec
        setTimeout(()=> render("home"), 900);
      };

      function showToast(msg, kind){
        const t = $("toast");
        if(!msg){
          t.style.display = "none";
          t.className = "toast";
          t.textContent = "";
          return;
        }
        t.style.display = "block";
        t.className = "toast " + (kind==="good" ? "good" : "bad");
        t.textContent = msg;
      }
    }

    /* =============================
      Final Question
    ============================== */
    function renderAsk(){
      if(!state.askUnlocked){
        render("home");
        return;
      }
      state.visited.ask = true;
      saveState();

      view.innerHTML = `
        <div class="section-head">
          <div class="crumb">
            <div class="back" id="backHome">‚Üê Men√∫</div>
            <div>Pregunta final üíò</div>
          </div>
          <div class="hint-badge">final</div>
        </div>

        <div class="final">
          <h3>¬øQuieres ser mi San Valent√≠n? üíó</h3>
          <p>(elige tu vibra üòº)</p>

          <div class="yn">
            <div class="yes" id="btnYes">S√≠ üíû</div>
            <div class="no" id="btnNo">No üôÑ</div>
          </div>

          <div class="final-msg" id="finalMsg">Ayyy s√≠ üò≠üíó ya sab√≠aaaaa. Te amo much√≠simo üòΩ‚ú®</div>
        </div>
      `;

      $("backHome").onclick = ()=> render("home");

      const btnNo = $("btnNo");
      const btnYes = $("btnYes");
      let dodgeCount = 0;

      function dodge(){
        // works on mouse + touch:
        // move button around randomly within the .final box
        const box = view.querySelector(".final");
        const rect = box.getBoundingClientRect();

        // keep inside with padding
        const pad = 14;
        const maxX = rect.width - 90;
        const maxY = rect.height - 80;

        const x = pad + Math.random() * (maxX - pad);
        const y = 60 + Math.random() * (maxY - 60);

        btnNo.style.position = "absolute";
        btnNo.style.left = x + "px";
        btnNo.style.top = y + "px";
        box.style.position = "relative";

        dodgeCount++;
        // make it slightly smaller each dodge (but not too aggressive)
        const scale = Math.max(0.72, 1 - dodgeCount*0.06);
        btnNo.style.transform = `scale(${scale})`;

        // after a few dodges, it becomes "S√≠" (cute prank)
        if(dodgeCount >= 6){
          btnNo.textContent = "S√≠ üíû";
          btnNo.classList.remove("no");
          btnNo.classList.add("yes");
          btnNo.onclick = ()=> acceptYes();
        }
      }

      function acceptYes(){
        confettiBurst();
        $("finalMsg").style.display = "block";
        // mark ask as done for progress
        state.visited.ask = true;
        saveState();
      }

      btnYes.onclick = acceptYes;

      // Desktop hover
      btnNo.addEventListener("mouseenter", dodge);
      // Mobile tap
      btnNo.addEventListener("touchstart", (e)=>{
        e.preventDefault();
        dodge();
      }, { passive:false });
      btnNo.addEventListener("click", dodge);
    }

    /* =============================
      UI Bits + Events
    ============================== */
    function updateUIBits(){
      // toggles
      $("toggleMusic").classList.toggle("on", state.musicOn);
      $("toggleHearts").classList.toggle("on", state.heartsOn);

      // top buttons
      $("btnMusic").classList.toggle("off", !state.musicOn);
      $("musicState").textContent = state.musicOn ? "ON" : "OFF";

      $("btnHearts").classList.toggle("off", !state.heartsOn);
      $("heartsState").textContent = state.heartsOn ? "ON" : "OFF";

      $("fsState").textContent = state.fullscreen ? "CINE" : "FULL";
      document.body.classList.toggle("fullscreen", state.fullscreen);

      // status pill
      const pill = $("statusPill");
      const unlocked = !!state.askUnlocked;
      pill.textContent = unlocked ? "Pregunta: desbloqueada ‚úÖ" : "Pregunta: bloqueada";
      pill.classList.toggle("good", unlocked);
      pill.classList.toggle("bad", !unlocked);

      // hearts
      if(state.heartsOn) startHearts();
      else stopHearts();

      // music
      if(state.musicOn){
        // try play if user has toggled
        audio.play().catch(()=>{});
      }else{
        audio.pause();
      }

      updateProgressUI();
    }

    // top buttons
    $("btnMusic").onclick = toggleMusic;
    $("toggleMusic").onclick = toggleMusic;

    $("btnHearts").onclick = ()=>{
      state.heartsOn = !state.heartsOn;
      saveState();
    };
    $("toggleHearts").onclick = ()=>{
      state.heartsOn = !state.heartsOn;
      saveState();
    };

    $("btnFullscreen").onclick = toggleFullscreenUI;

    $("btnCopy").onclick = async ()=>{
      const url = location.href;
      try{
        await navigator.clipboard.writeText(url);
        // tiny feedback
        $("btnCopy").textContent = "‚úÖ Copiado";
        setTimeout(()=> $("btnCopy").textContent = "üîó Copiar link", 900);
      }catch{
        // fallback prompt
        prompt("Copia este link:", url);
      }
    };

    $("btnReset").onclick = ()=>{
      if(confirm("¬øSeguro? Esto borra el progreso guardado en el cel üòº")){
        hardReset();
      }
    };

    // if first load, apply toggles
    if(state.heartsOn) startHearts();
    updateUIBits();

    // Initial route
    render("home");
  </script>
</body>
</html>
