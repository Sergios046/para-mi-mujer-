<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ffeaf3" />
  <title>Saharaim üíò</title>

  <style>
    :root{
      --bg1:#fff1f7;
      --bg2:#f3f0ff;
      --bg3:#eafffb;
      --ink:#2b2b35;
      --mut:#5c5c6a;
      --card:#ffffffcc;
      --shadow: 0 18px 50px rgba(41, 16, 36, .12);
      --shadow2: 0 8px 24px rgba(41, 16, 36, .10);
      --pink:#ff6fae;
      --violet:#a78bfa;
      --mint:#4fd1c5;
      --sun:#ffcc7a;
      --radius:22px;
      --ease: cubic-bezier(.2,.9,.2,1);
      --glass: blur(12px);
      --font: ui-rounded, system-ui, -apple-system, "SF Pro Rounded", "Segoe UI", Roboto, Arial, sans-serif;

      /* ‚úÖ OPCIONAL: fondo con foto (sube assets/bg.jpg) */
      --bgimg: none; /* url("./assets/bg.jpg") */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--font);
      color:var(--ink);
      background:
        radial-gradient(1100px 700px at 12% 10%, var(--bg2) 0%, transparent 60%),
        radial-gradient(1000px 650px at 88% 15%, var(--bg1) 0%, transparent 55%),
        radial-gradient(1200px 750px at 50% 95%, var(--bg3) 0%, transparent 55%),
        linear-gradient(180deg, #fff, #fff7fb 35%, #f7f4ff 70%, #f2fffd);
      overflow-x:hidden;
    }

    body::before{
      content:"";
      position:fixed; inset:0;
      background-image: var(--bgimg);
      background-size: cover;
      background-position:center;
      filter: blur(8px) brightness(.78) saturate(1.05);
      opacity:.35;
      pointer-events:none;
      z-index:-2;
    }
    body::after{
      content:"";
      position:fixed; inset:0;
      background: linear-gradient(180deg, rgba(255,255,255,.75), rgba(255,255,255,.85));
      pointer-events:none;
      z-index:-1;
    }

    .wrap{
      min-height:100%;
      display:grid;
      place-items:center;
      padding: 18px 14px 26px;
    }
    .app{
      width:min(920px, 96vw);
      background: var(--card);
      border: 1px solid rgba(255,255,255,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: var(--glass);
      -webkit-backdrop-filter: var(--glass);
      overflow:hidden;
      position:relative;
      transform-style:preserve-3d;
      transition: transform .18s var(--ease);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.75);
      background: linear-gradient(90deg, rgba(255,255,255,.65), rgba(255,255,255,.35));
    }

    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:900;
      letter-spacing:.2px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.7);
      box-shadow: var(--shadow2);
      border: 1px solid rgba(255,255,255,.9);
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: conic-gradient(from 0deg, var(--pink), var(--violet), var(--mint), var(--pink));
      box-shadow: 0 0 18px rgba(255,111,174,.35);
      animation: pulse 1.8s var(--ease) infinite;
    }
    @keyframes pulse { 50% { transform: scale(1.25); filter: brightness(1.05);} }

    .actions{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .iconbtn{
      border: 1px solid rgba(255,255,255,.9);
      background: rgba(255,255,255,.7);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      font-weight: 800;
      transition: transform .15s var(--ease), box-shadow .15s var(--ease), background .15s var(--ease), opacity .15s var(--ease);
      user-select:none;
      touch-action: manipulation;
      position:relative;
      overflow:hidden;
    }
    .iconbtn:hover{ transform: translateY(-1px) scale(1.02); }
    .iconbtn:active{ transform: translateY(0px) scale(.98); }
    .iconbtn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

    .main{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      padding: 14px;
    }
    @media (max-width: 860px){
      .main{ grid-template-columns: 1fr; }
    }

    .panel{
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(255,255,255,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }

    .hero h1{
      margin: 6px 0 6px;
      font-size: clamp(22px, 3.6vw, 40px);
      line-height: 1.1;
    }
    .hero p{
      margin:0 0 12px;
      color:var(--mut);
      line-height:1.5;
      font-weight: 650;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
      margin-top: 12px;
    }
    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
    }

    .tile{
      border: 1px solid rgba(255,255,255,.9);
      background: rgba(255,255,255,.72);
      border-radius: 18px;
      padding: 14px;
      cursor:pointer;
      box-shadow: var(--shadow2);
      transition: transform .18s var(--ease), box-shadow .18s var(--ease), background .18s var(--ease);
      position:relative;
      overflow:hidden;
      user-select:none;
      touch-action: manipulation;
    }
    .tile:hover{ transform: translateY(-2px) scale(1.01); }
    .tile:active{ transform: translateY(0px) scale(.98); }
    .tile .t-top{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .tile .emoji{ font-size: 22px; }
    .tile .name{ font-weight: 950; letter-spacing:.2px; }
    .tile .desc{ margin-top:6px; color:var(--mut); font-weight:650; line-height:1.4; font-size: 13.5px; }
    .tile .spark{
      position:absolute; inset:-2px;
      background:
        radial-gradient(280px 120px at 12% 22%, rgba(255,111,174,.22), transparent 60%),
        radial-gradient(280px 120px at 88% 78%, rgba(79,209,197,.16), transparent 65%),
        radial-gradient(300px 120px at 75% 20%, rgba(167,139,250,.14), transparent 60%);
      opacity:.85;
      pointer-events:none;
      transition: opacity .18s var(--ease);
    }
    .tile:hover .spark{ opacity: 1; }
    .badge{
      font-size: 12px;
      font-weight: 950;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(255,255,255,.9);
      box-shadow: var(--shadow2);
      white-space:nowrap;
    }

    .screen{ display:none; animation: in .28s var(--ease); }
    .screen.active{ display:block; }
    @keyframes in { from{opacity:0; transform: translateY(10px) scale(.99);} to{opacity:1; transform: translateY(0) scale(1);} }

    .backRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom: 10px; }
    .back{
      display:inline-flex; align-items:center; gap:8px;
      border: 1px solid rgba(255,255,255,.9);
      background: rgba(255,255,255,.72);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 950;
      box-shadow: var(--shadow2);
      transition: transform .15s var(--ease);
      user-select:none;
      touch-action: manipulation;
      position:relative;
      overflow:hidden;
    }
    .back:hover{ transform: translateY(-1px); }
    .back:active{ transform: translateY(0) scale(.98); }

    .letter{
      background: linear-gradient(180deg, rgba(255,255,255,.85), rgba(255,255,255,.68));
      border: 1px solid rgba(255,255,255,.92);
      border-radius: 18px;
      padding: 16px;
      box-shadow: var(--shadow2);
      position:relative;
      overflow:hidden;
    }
    .letter::before{
      content:"";
      position:absolute; inset:-6px;
      background:
        repeating-linear-gradient(90deg, rgba(255,111,174,.08) 0 1px, transparent 1px 24px),
        radial-gradient(420px 140px at 20% 10%, rgba(255,204,122,.18), transparent 60%),
        radial-gradient(420px 140px at 80% 90%, rgba(167,139,250,.16), transparent 60%);
      opacity:.6;
      pointer-events:none;
    }
    .letter h2{
      margin: 0 0 10px;
      font-size: 20px;
      letter-spacing:.2px;
    }
    .paper{
      position:relative;
      background: rgba(255,255,255,.88);
      border: 1px solid rgba(255,255,255,.95);
      border-radius: 16px;
      padding: 14px 14px 12px;
      box-shadow: 0 10px 30px rgba(41,16,36,.08);
    }
    .paper p{
      margin:0;
      color:#2c2c36;
      line-height:1.7;
      font-weight: 650;
      font-size: 15px;
      white-space:pre-wrap;
    }
    .sig{
      margin-top: 10px;
      color: var(--mut);
      font-weight: 800;
      font-size: 13px;
    }

    .qbox{
      background: rgba(255,255,255,.76);
      border: 1px solid rgba(255,255,255,.92);
      border-radius: 18px;
      padding: 16px;
      box-shadow: var(--shadow2);
    }
    .qbox h2{ margin:0 0 8px; font-size: 20px; }
    .qbox p{ margin:0 0 12px; color:var(--mut); font-weight: 700; line-height:1.5; }
    .btnRow{
      display:flex; gap:12px; flex-wrap:wrap; justify-content:center;
      margin-top: 10px;
    }
    .btn{
      position:relative;
      border: 1px solid rgba(255,255,255,.92);
      background: rgba(255,255,255,.78);
      padding: 12px 14px;
      border-radius: 16px;
      cursor:pointer;
      font-weight: 950;
      min-width: 150px;
      box-shadow: var(--shadow2);
      transition: transform .16s var(--ease), box-shadow .16s var(--ease);
      user-select:none;
      touch-action: manipulation;
      overflow:hidden;
    }
    .btn:hover{ transform: translateY(-2px) scale(1.02); }
    .btn:active{ transform: translateY(0) scale(.98); }
    .btn.primary{
      background: linear-gradient(180deg, rgba(255,111,174,.22), rgba(255,255,255,.78));
      border-color: rgba(255,111,174,.35);
    }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

    .term{
      background: rgba(255,255,255,.72);
      border: 1px solid rgba(255,255,255,.92);
      border-radius: 18px;
      padding: 14px;
      box-shadow: var(--shadow2);
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color:#2e2e3a;
      overflow:hidden;
      position:relative;
    }
    .term .prompt{ font-weight:900; color:#5b5bd6; }
    .term pre{
      margin: 10px 0 0;
      white-space:pre-wrap;
      line-height:1.55;
      font-size: 13.8px;
    }
    .cursor{
      display:inline-block;
      width:10px;
      border-bottom:2px solid rgba(43,43,53,.7);
      animation: blink .9s steps(1) infinite;
      margin-left:2px;
    }
    @keyframes blink{ 50%{ opacity:0; } }

    .ripple{
      position:absolute; border-radius:50%;
      transform: translate(-50%,-50%);
      pointer-events:none;
      width: 10px; height: 10px;
      opacity:.4;
      background: radial-gradient(circle, rgba(255,111,174,.55), transparent 60%);
      animation: rip 650ms var(--ease) forwards;
    }
    @keyframes rip{
      to{ width: 540px; height: 540px; opacity:0; }
    }

    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(255,255,255,.95);
      box-shadow: var(--shadow2);
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 950;
      display:none;
      max-width: calc(100vw - 24px);
      text-align:center;
      z-index: 9999;
    }

    #fx{
      position: fixed; inset:0;
      pointer-events:none;
      z-index: 9998;
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation: none !important; transition: none !important; }
    }
  </style>
</head>

<body>
  <canvas id="fx"></canvas>

  <div class="wrap">
    <div class="app" id="app">
      <div class="topbar">
        <div class="brand">
          <span class="pill"><span class="dot"></span> valentine.app</span>
          <span class="pill">para <b>Saharaim</b> üíò</span>
        </div>

        <div class="actions">
          <button class="iconbtn" id="musicBtn">üéµ M√∫sica: OFF</button>
          <button class="iconbtn" id="heartsBtn">üíñ Corazones: ON</button>
          <button class="iconbtn" id="copyBtn">üìã Copiar link</button>
        </div>
      </div>

      <div class="main">
        <!-- LEFT: screens -->
        <div class="panel">
          <!-- HOME -->
          <div class="screen active hero" id="screen-home">
            <h1>Hey Saharaim üíò</h1>
            <p>
              Hice esto para ti en versi√≥n pastel + rom√°ntico + dev.
              Expl√≥ralo con calma. Aqu√≠ todo tiene acci√≥n (y mucho cari√±o).
            </p>

            <div class="grid">
              <div class="tile" data-go="letter">
                <div class="spark"></div>
                <div class="t-top">
                  <div class="name"><span class="emoji">üíå</span> Carta</div>
                  <div class="badge">leer</div>
                </div>
                <div class="desc">Una cartita corta, sincera, y bien t√∫ y yo.</div>
              </div>

              <div class="tile" data-go="test" id="tileTest">
                <div class="spark"></div>
                <div class="t-top">
                  <div class="name"><span class="emoji">üß†</span> Mini test</div>
                  <div class="badge" id="tBadge">start</div>
                </div>
                <div class="desc">3 preguntas r√°pidas. Si ganas, desbloqueas la pregunta üíò</div>
              </div>

              <div class="tile" data-go="question" id="tileQuestion">
                <div class="spark"></div>
                <div class="t-top">
                  <div class="name"><span class="emoji">üíò</span> Pregunta</div>
                  <div class="badge" id="qBadge">üîí locked</div>
                </div>
                <div class="desc">Se desbloquea cuando termines el mini test üòº</div>
              </div>

              <div class="tile" data-go="photos">
                <div class="spark"></div>
                <div class="t-top">
                  <div class="name"><span class="emoji">üì∏</span> Fotos</div>
                  <div class="badge">beta</div>
                </div>
                <div class="desc">Luego metemos recuerdos (swipe y captions).</div>
              </div>
            </div>
          </div>

          <!-- LETTER -->
          <div class="screen" id="screen-letter">
            <div class="backRow">
              <div class="back" data-go="home">‚Üê Men√∫</div>
              <div class="badge">carta</div>
            </div>

            <div class="letter">
              <h2>Una carta para ti üíå</h2>
              <div class="paper">
                <p id="letterText"></p>
                <div class="sig">‚Äî (firma aqu√≠ con tu nombre)</div>
              </div>
              <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                <button class="iconbtn" id="retypeBtn">‚ú® Releer con efecto</button>
                <button class="iconbtn" data-go="test">üß† Ir al mini test</button>
              </div>
            </div>
          </div>

          <!-- TEST -->
          <div class="screen" id="screen-test">
            <div class="backRow">
              <div class="back" data-go="home">‚Üê Men√∫</div>
              <div class="badge" id="testStatus">test</div>
            </div>

            <div class="qbox">
              <h2>Mini test üß†</h2>
              <p id="testHint">Contesta 3. Si sacas 2/3, se desbloquea la secci√≥n üíò</p>

              <div class="letter" style="margin-top:12px;">
                <div class="paper">
                  <p style="font-weight:950; margin-bottom:10px;">1) ¬øCu√°l es mi comida favorita?</p>
                  <div class="btnRow">
                    <button class="btn" data-a="0" data-q="0">Tacos</button>
                    <button class="btn" data-a="1" data-q="0">Sushi</button>
                    <button class="btn" data-a="2" data-q="0">Pizza</button>
                  </div>
                </div>
              </div>

              <div class="letter" style="margin-top:12px;">
                <div class="paper">
                  <p style="font-weight:950; margin-bottom:10px;">2) ¬øQu√© me gusta m√°s hacer contigo?</p>
                  <div class="btnRow">
                    <button class="btn" data-a="0" data-q="1">Ir por comida</button>
                    <button class="btn" data-a="1" data-q="1">Ver pelis</button>
                    <button class="btn" data-a="2" data-q="1">Solo estar contigo</button>
                  </div>
                </div>
              </div>

              <div class="letter" style="margin-top:12px;">
                <div class="paper">
                  <p style="font-weight:950; margin-bottom:10px;">3) ¬øCu√°l es mi ‚Äúdetalle‚Äù favorito?</p>
                  <div class="btnRow">
                    <button class="btn" data-a="0" data-q="2">Cartas</button>
                    <button class="btn" data-a="1" data-q="2">Flores</button>
                    <button class="btn" data-a="2" data-q="2">Postres</button>
                  </div>
                </div>
              </div>

              <div class="btnRow" style="margin-top:14px;">
                <button class="btn primary" id="submitTest">‚úÖ Ver resultado</button>
                <button class="btn" id="resetTest">üßº Reiniciar</button>
              </div>

              <div class="term" style="margin-top:12px;">
                <div><span class="prompt">test@love</span>:~$ <span id="testCmd"></span><span class="cursor"></span></div>
                <pre id="testOut"></pre>
              </div>
            </div>
          </div>

          <!-- PHOTOS -->
          <div class="screen" id="screen-photos">
            <div class="backRow">
              <div class="back" data-go="home">‚Üê Men√∫</div>
              <div class="badge">beta</div>
            </div>

            <div class="qbox">
              <h2>Fotos üì∏</h2>
              <p>
                Esta secci√≥n la dejamos lista para despu√©s.
                Cuando quieras, metemos swipe + captions tipo ‚Äúaqu√≠ fue cuando‚Ä¶‚Äù.
              </p>
              <div class="term">
                <div><span class="prompt">dev@love</span>:~$ <span id="phCmd"></span><span class="cursor"></span></div>
                <pre id="phOut"></pre>
              </div>
              <div class="btnRow">
                <button class="btn" data-go="home">Volver</button>
                <button class="btn primary" data-go="letter">Leer carta</button>
              </div>
            </div>
          </div>

          <!-- QUESTION -->
          <div class="screen" id="screen-question">
            <div class="backRow">
              <div class="back" data-go="home">‚Üê Men√∫</div>
              <div class="badge">momento</div>
            </div>

            <div class="qbox">
              <h2>Tengo una pregunta‚Ä¶ üíò</h2>
              <p>Ok‚Ä¶ ahora s√≠. Gracias por jugar bonito üòå</p>

              <div class="term" style="margin-top:12px;">
                <div><span class="prompt">patr√≥n@love</span>:~$ <span id="qCmd"></span><span class="cursor"></span></div>
                <pre id="qOut"></pre>
              </div>

              <div class="btnRow" style="margin-top:12px;">
                <button class="btn primary" id="yesBtn">‚úÖ S√≠</button>
                <button class="btn" id="noBtn">ü§ç Todav√≠a no</button>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT -->
        <div class="panel">
          <div class="term">
            <div><span class="prompt">system@pastel</span>:~$ <span id="sysCmd"></span><span class="cursor"></span></div>
            <pre id="sysOut"></pre>
          </div>

          <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="iconbtn" id="confettiBtn">üéâ Confeti</button>
            <button class="iconbtn" id="softResetBtn">üßº Reset</button>
          </div>

          <div style="margin-top:12px; color:var(--mut); font-weight:700; line-height:1.5; font-size:13.5px;">
            ‚Ä¢ ‚ÄúPregunta‚Äù se desbloquea con el mini test.<br/>
            ‚Ä¢ Se guarda el progreso (localStorage).<br/>
            ‚Ä¢ Luego metemos fotos con swipe y captions.
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  function showToast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> t.style.display="none", 2200);
  }
  function vibrate(pattern){ try{ if(navigator.vibrate) navigator.vibrate(pattern); }catch{} }

  // ---------- Screen system ----------
  const screens = {
    home: $("screen-home"),
    letter: $("screen-letter"),
    test: $("screen-test"),
    photos: $("screen-photos"),
    question: $("screen-question"),
  };
  function _go(name){
    Object.values(screens).forEach(s => s.classList.remove("active"));
    screens[name].classList.add("active");
    vibrate([18]);
  }

  // ---------- Ripple ----------
  function addRipple(el, x, y){
    const r = document.createElement("span");
    r.className = "ripple";
    r.style.left = x + "px";
    r.style.top = y + "px";
    el.appendChild(r);
    setTimeout(()=> r.remove(), 700);
  }
  document.addEventListener("pointerdown", (e)=>{
    const target = e.target.closest(".btn, .iconbtn, .tile, .back");
    if(!target) return;
    const rect = target.getBoundingClientRect();
    addRipple(target, e.clientX - rect.left, e.clientY - rect.top);
  }, {passive:true});

  // ---------- Typewriter (FIXED: cancel previous runs) ----------
  const sleep = (ms)=>new Promise(r=>setTimeout(r, ms));

  // Token that invalidates previous typing loops
  let typeToken = 0;

  async function typeInto(el, text, base=18){
    const myToken = ++typeToken;       // new run id
    el.textContent = "";

    for(const ch of text){
      // if another typeInto started, stop this one
      if(myToken !== typeToken) return;

      el.textContent += ch;
      await sleep(base + Math.random()*22);
    }
  }

  async function typePre(el, lines, base=90){
    const myToken = ++typeToken;
    el.textContent = "";
    for(const line of lines){
      if(myToken !== typeToken) return;
      el.textContent += line + "\n";
      await sleep(base + Math.random()*90);
    }
  }

  // ---------- Letter content (EDITA AQU√ç) ----------
  const LETTER = `Saharaim,

No hice esto porque no sepa decirte las cosas en persona,
sino porque quer√≠a dejarlas aqu√≠, bonitas, y a tu ritmo.

Me gusta todo de ti‚Ä¶ pero sobre todo lo real:
c√≥mo eres cuando est√°s tranquila,
c√≥mo te r√≠es,
y c√≥mo haces que lo simple se sienta especial.

Gracias por ser mi lugar bonito.
Me encantas.

Con cari√±o,`;

  const retypeBtn = $("retypeBtn");
  let typingLetter = false;

  async function renderLetter(animated=true){
    const el = $("letterText");

    // Cancel any typing currently happening (important)
    typeToken++;

    if(!animated){
      el.textContent = LETTER;
      typingLetter = false;
      if(retypeBtn) retypeBtn.disabled = false;
      return;
    }

    // prevent spam-click weirdness
    typingLetter = true;
    if(retypeBtn) retypeBtn.disabled = true;

    await typeInto(el, LETTER, 14);

    // if got canceled, don't re-enable too early
    if(!typingLetter) return;

    typingLetter = false;
    if(retypeBtn) retypeBtn.disabled = false;
  }

  retypeBtn.addEventListener("click", ()=>{
    vibrate([30,20,30]);
    showToast("Ok‚Ä¶ otra vez üíå");
    renderLetter(true);
  });

  // ---------- Lock system ----------
  let unlockedQuestion = localStorage.getItem("unlockedQuestion") === "1";
  const picks = [null, null, null];
  const ANSWERS = [1, 2, 0]; // Q1=Sushi, Q2=Solo estar contigo, Q3=Cartas

  function updateLocks(){
    const qBadge = $("qBadge");
    const tBadge = $("tBadge");
    if(unlockedQuestion){
      qBadge.textContent = "‚úÖ unlocked";
      tBadge.textContent = "done";
      $("tileQuestion").querySelector(".desc").textContent = "Ya est√° desbloqueada üòº";
    }else{
      qBadge.textContent = "üîí locked";
      tBadge.textContent = "start";
      $("tileQuestion").querySelector(".desc").textContent = "Se desbloquea cuando termines el mini test üòº";
    }
  }

  function go(name){
    if(name === "question" && !unlockedQuestion){
      showToast("üîí Primero completa el mini test üß†");
      vibrate([25,25,25]);
      return;
    }
    _go(name);
  }

  document.addEventListener("click", (e)=>{
    const goTo = e.target.closest("[data-go]")?.getAttribute("data-go");
    if(goTo) go(goTo);
  });

  updateLocks();

  // ---------- Test picks ----------
  document.addEventListener("click", (e)=>{
    const btn = e.target.closest("button[data-q][data-a]");
    if(!btn) return;

    const q = Number(btn.getAttribute("data-q"));
    const a = Number(btn.getAttribute("data-a"));
    picks[q] = a;

    const parent = btn.parentElement;
    [...parent.querySelectorAll("button")].forEach(b => b.style.transform = "");
    btn.style.transform = "translateY(-2px) scale(1.03)";

    showToast("Respuesta guardada ‚úÖ");
    vibrate([18]);
  });

  $("submitTest").addEventListener("click", async ()=>{
    if(picks.some(v => v === null)){
      showToast("Te falta contestar una üòº");
      vibrate([30,30]);
      return;
    }

    let score = 0;
    for(let i=0;i<3;i++) if(picks[i] === ANSWERS[i]) score++;

    await typeInto($("testCmd"), "node miniTest.js --run", 12);

    const lines = [`‚Üí score: ${score}/3`];

    if(score >= 2){
      unlockedQuestion = true;
      localStorage.setItem("unlockedQuestion","1");
      updateLocks();
      spawnConfetti(220);
      vibrate([120,60,120]);
      lines.push("‚Üí status: PASASTE ‚úÖ");
      lines.push("‚Üí desbloqueado: secci√≥n Pregunta üíò");
      showToast("‚úÖ Desbloqueado üíò");
    }else{
      vibrate([40,20,40]);
      lines.push("‚Üí status: casi üò≠ intenta otra vez");
      showToast("Intenta otra vez üòº");
    }

    await typePre($("testOut"), lines, 70);
  });

  $("resetTest").addEventListener("click", ()=>{
    for(let i=0;i<picks.length;i++) picks[i] = null;
    document.querySelectorAll("button[data-q][data-a]").forEach(b => b.style.transform = "");
    $("testOut").textContent = "";
    $("testCmd").textContent = "";
    showToast("Reiniciado üßº");
    vibrate([18]);
  });

  // ---------- Question actions ----------
  $("yesBtn").addEventListener("click", async ()=>{
    spawnConfetti(260);
    vibrate([120,60,120]);
    showToast("AAAAA üíò");

    await typeInto($("qCmd"), "git merge love/valentine --no-ff", 10);
    await typePre($("qOut"), [
      "‚Üí Respuesta: S√ç üíò",
      "‚Üí Deploy: aprobado ‚úÖ",
      "‚Üí Nota: eres mi persona favorita.",
      "‚Üí Fin del commit üòå"
    ], 70);
  });

  $("noBtn").addEventListener("click", async ()=>{
    vibrate([40,30,40]);
    showToast("Todo bien üòå");

    await typeInto($("qCmd"), "setTimeout(() => askAgain(), 86400000)", 10);
    await typePre($("qOut"), [
      "‚Üí Ok, sin presi√≥n.",
      "‚Üí Modo paciencia activado üßò‚Äç‚ôÇÔ∏è",
      "‚Üí (Cuando quieras, aqu√≠ estoy) üíó"
    ], 70);
  });

  // ---------- Photos placeholder terminal ----------
  async function bootTerminals(){
    await typeInto($("sysCmd"), "boot --pastel --romantic --mobile", 12);
    await typePre($("sysOut"), [
      "‚Üí UI: pastel glass ‚úÖ",
      "‚Üí locks: enabled ‚úÖ",
      "‚Üí test: required ‚úÖ",
      "‚Üí status: ready for Saharaim üíò"
    ], 70);

    await typeInto($("phCmd"), "photos.init --mode=swipe", 12);
    await typePre($("phOut"), [
      "‚Üí assets: pending upload",
      "‚Üí todo: add captions + swipe gestures",
      "‚Üí status: waiting ‚ú®"
    ], 70);
  }

  // ---------- Confetti / hearts ----------
  const canvas = $("fx");
  const ctx = canvas.getContext("2d");
  function resize(){
    const dpr = devicePixelRatio || 1;
    canvas.width = innerWidth * dpr;
    canvas.height = innerHeight * dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener("resize", resize, {passive:true});
  resize();

  let particles = [];
  let heartsOn = true;

  function spawnConfetti(n=160){
    for(let i=0;i<n;i++){
      particles.push({
        x: innerWidth*(0.2 + Math.random()*0.6),
        y: innerHeight*0.15 + Math.random()*30,
        vx: (Math.random()-0.5)*3.0,
        vy: (1.8 + Math.random()*2.6),
        s: 3 + Math.random()*6,
        life: 1,
        kind: Math.random()<0.35 ? "heart" : "dot",
        hue: 300 + Math.random()*90
      });
    }
  }

  function drawHeart(x,y,s,hue,alpha){
    ctx.save();
    ctx.translate(x,y);
    ctx.scale(s/18, s/18);
    ctx.globalAlpha = alpha;
    ctx.fillStyle = `hsl(${hue} 95% 70%)`;
    ctx.beginPath();
    ctx.moveTo(0, 6.2);
    ctx.bezierCurveTo(0, 0, -9, 0, -9, 6.2);
    ctx.bezierCurveTo(-9, 12.5, 0, 16.5, 0, 21);
    ctx.bezierCurveTo(0, 16.5, 9, 12.5, 9, 6.2);
    ctx.bezierCurveTo(9, 0, 0, 0, 0, 6.2);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function tick(){
    ctx.clearRect(0,0,innerWidth,innerHeight);
    particles = particles.filter(p => p.life > 0.03 && p.y < innerHeight + 60);

    for(const p of particles){
      p.x += p.vx;
      p.y += p.vy;
      p.vy += 0.03;
      p.life *= 0.985;

      const alpha = Math.max(0, p.life);
      if(!heartsOn && p.kind === "heart") continue;

      if(p.kind === "heart"){
        drawHeart(p.x, p.y, p.s, p.hue, alpha);
      }else{
        ctx.globalAlpha = alpha;
        ctx.fillStyle = `hsl(${p.hue} 95% 70%)`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.s*0.5, 0, Math.PI*2);
        ctx.fill();
      }
    }
    requestAnimationFrame(tick);
  }
  tick();

  // ---------- Music toggle ----------
  let audioCtx = null;
  let musicOn = false;
  let nodes = [];

  function stopMusic(){
    nodes.forEach(n => { try{ n.stop?.(); n.disconnect?.(); }catch{} });
    nodes = [];
    musicOn = false;
    $("musicBtn").textContent = "üéµ M√∫sica: OFF";
  }

  function startMusic(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const ctxA = audioCtx;

    const base = 220;
    const freqs = [base, base*1.25, base*1.5];

    const master = ctxA.createGain();
    master.gain.value = 0.035;
    master.connect(ctxA.destination);

    const filter = ctxA.createBiquadFilter();
    filter.type = "lowpass";
    filter.frequency.value = 900;
    filter.connect(master);

    freqs.forEach((f)=>{
      const o = ctxA.createOscillator();
      const g = ctxA.createGain();
      o.type = "sine";
      o.frequency.value = f;
      g.gain.value = 0.6 / freqs.length;
      o.connect(g); g.connect(filter);
      o.start();
      nodes.push(o, g);
    });

    const lfo = ctxA.createOscillator();
    const lfoGain = ctxA.createGain();
    lfo.type = "sine";
    lfo.frequency.value = 0.18;
    lfoGain.gain.value = 60;
    lfo.connect(lfoGain);
    lfoGain.connect(filter.frequency);
    lfo.start();
    nodes.push(lfo, lfoGain);

    musicOn = true;
    $("musicBtn").textContent = "üéµ M√∫sica: ON";
  }

  $("musicBtn").addEventListener("click", async ()=>{
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      await audioCtx.resume();
    }catch{}
    if(musicOn){ stopMusic(); showToast("M√∫sica off ü§´"); }
    else{ startMusic(); showToast("M√∫sica on üé∂"); vibrate([20]); }
  });

  $("heartsBtn").addEventListener("click", ()=>{
    heartsOn = !heartsOn;
    $("heartsBtn").textContent = heartsOn ? "üíñ Corazones: ON" : "ü§ç Corazones: OFF";
    showToast(heartsOn ? "Corazones ON üíñ" : "Corazones OFF ü§ç");
    vibrate([18]);
  });

  $("copyBtn").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(location.href);
      showToast("Link copiado üìã");
      vibrate([20,30,20]);
    }catch{
      showToast("No pude copiar üòÖ (copia manual)");
    }
  });

  $("confettiBtn").addEventListener("click", ()=>{
    spawnConfetti(190);
    showToast("Confeti üéâ");
    vibrate([60,40,60]);
  });

  $("softResetBtn").addEventListener("click", ()=>{
    stopMusic();
    heartsOn = true;
    $("heartsBtn").textContent = "üíñ Corazones: ON";
    localStorage.removeItem("unlockedQuestion");
    unlockedQuestion = false;
    updateLocks();
    for(let i=0;i<picks.length;i++) picks[i] = null;
    document.querySelectorAll("button[data-q][data-a]").forEach(b => b.style.transform = "");
    $("testOut").textContent = "";
    $("testCmd").textContent = "";
    $("qOut").textContent = "";
    $("qCmd").textContent = "";
    _go("home");
    renderLetter(false);
    bootTerminals();
    showToast("Reset completo üßº");
    vibrate([18,18,18]);
  });

  // ---------- Init ----------
  (async function init(){
    await renderLetter(true);
    bootTerminals();
  })();
})();
</script>
</body>
</html>
