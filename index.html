<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Para Saharaim üíò</title>

  <style>
    :root{
      --bg1:#fff3f8;
      --bg2:#f6f8ff;
      --card: rgba(255,255,255,.78);
      --card2: rgba(255,255,255,.88);
      --stroke: rgba(0,0,0,.06);
      --txt:#1f1f2b;
      --mut: rgba(31,31,43,.62);
      --pink:#ff5aa5;
      --pink2:#ff8bc5;
      --purple:#7c6cff;
      --shadow: 0 18px 55px rgba(28,18,40,.14);
      --ease: cubic-bezier(.2,.9,.2,1);
      --radius: 22px;
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--txt);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(255,90,165,.18), transparent 60%),
        radial-gradient(1000px 700px at 85% 20%, rgba(124,108,255,.16), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Optional background image (when you upload one) */
    body.has-bg::before{
      content:"";
      position:fixed;
      inset:0;
      background-image: var(--bgimg);
      background-size: cover;
      background-position:center;
      background-repeat:no-repeat;
      filter: saturate(1.05) contrast(1.02);
      opacity:.22;              /* no estira, no pixelea tanto */
      transform: scale(1.02);   /* evita bordes */
      z-index:-2;
    }
    body.has-bg::after{
      content:"";
      position:fixed;
      inset:0;
      background: linear-gradient(180deg, rgba(255,243,248,.72), rgba(246,248,255,.86));
      z-index:-1;
    }

    .wrap{
      max-width: 1100px;
      margin: 28px auto;
      padding: 0 16px 40px;
    }

    .topbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }

    .brand{
      display:flex;
      gap:10px;
      align-items:center;
      padding-left: 4px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 9px 12px;
      border-radius:999px;
      border:1px solid var(--stroke);
      background: var(--card2);
      font-weight: 800;
      letter-spacing:.2px;
      user-select:none;
      white-space:nowrap;
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background: linear-gradient(90deg, var(--pink), var(--purple));
      box-shadow: 0 6px 16px rgba(255,90,165,.35);
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button, .btn{
      border:1px solid var(--stroke);
      background: var(--card2);
      border-radius: 999px;
      padding: 9px 12px;
      cursor:pointer;
      font-weight:800;
      color:var(--txt);
      transition: transform .15s var(--ease), box-shadow .15s var(--ease), background .15s var(--ease);
      user-select:none;
    }
    button:hover, .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 26px rgba(28,18,40,.12); }
    button:active, .btn:active{ transform: translateY(0px) scale(.99); }
    button.primary{
      background: linear-gradient(90deg, rgba(255,90,165,.95), rgba(255,139,197,.95));
      color:white;
      border-color: rgba(255,90,165,.30);
      box-shadow: 0 16px 34px rgba(255,90,165,.25);
    }
    button.ghost{
      background: transparent;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 16px;
    }

    .panel{
      background: var(--card);
      border:1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      overflow:hidden;
    }

    .panelHeader{
      padding: 16px 16px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(0,0,0,.04);
    }
    .panelHeader h1{
      font-size: 18px;
      margin:0;
      font-weight: 950;
    }
    .panelHeader .sub{
      margin:0;
      color: var(--mut);
      font-weight: 700;
      font-size: 13px;
    }

    .content{
      padding: 16px;
    }

    .menu{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 12px;
    }
    @media (min-width: 820px){
      .menu{ grid-template-columns: repeat(4, minmax(0,1fr)); }
      .grid{ grid-template-columns: 1.12fr .88fr; align-items:start; }
    }

    .tile{
      padding: 14px;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.72);
      cursor:pointer;
      transition: transform .15s var(--ease), box-shadow .15s var(--ease);
      min-height: 92px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
    }
    .tile:hover{ transform: translateY(-2px); box-shadow: 0 18px 40px rgba(28,18,40,.12); }
    .tile .t{
      font-weight: 950;
      font-size: 14.5px;
    }
    .tile .d{
      color: var(--mut);
      font-weight: 700;
      font-size: 12.5px;
      margin-top: 6px;
      line-height: 1.2;
    }
    .tile.locked{
      opacity: .55;
      position: relative;
    }
    .tile.locked::after{
      content:"üîí Bloqueado";
      position:absolute;
      top:10px;
      right:10px;
      font-weight: 900;
      font-size: 12px;
      color: rgba(31,31,43,.68);
      background: rgba(255,255,255,.85);
      border:1px solid rgba(0,0,0,.06);
      padding: 6px 9px;
      border-radius: 999px;
    }

    /* Letter */
    .letterWrap{
      display:grid;
      gap:12px;
    }
    .paper{
      background: rgba(255,255,255,.86);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 18px 40px rgba(28,18,40,.10);
      position:relative;
      overflow:hidden;
    }
    .paper::before{
      content:"";
      position:absolute; inset:-40px;
      background: radial-gradient(circle at 20% 10%, rgba(255,90,165,.10), transparent 55%),
                  radial-gradient(circle at 80% 10%, rgba(124,108,255,.10), transparent 55%);
      filter: blur(14px);
      pointer-events:none;
    }
    .paperInner{ position:relative; }
    .paperTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 10px;
    }
    .paperTitle h2{ margin:0; font-size: 18px; font-weight: 950; }
    .paperTitle span{ color:var(--mut); font-weight:800; font-size: 12.5px; }
    .letterText{
      white-space: pre-wrap;
      line-height: 1.55;
      font-weight: 700;
      color: rgba(31,31,43,.88);
      font-size: 14.5px;
      min-height: 180px;
    }
    .sig{
      margin-top: 14px;
      font-weight: 950;
      color: rgba(31,31,43,.92);
    }

    /* Photos */
    .photoGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
    }
    .photoCard{
      grid-column: span 6;
      background: rgba(255,255,255,.82);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 18px;
      padding: 12px;
      box-shadow: 0 18px 45px rgba(28,18,40,.12);
      transition: transform .18s var(--ease), box-shadow .18s var(--ease);
      cursor:pointer;
      transform: rotate(var(--tilt, 0deg));
      position: relative;
      overflow:hidden;
    }
    .photoCard:hover{
      transform: rotate(var(--tilt, 0deg)) translateY(-3px) scale(1.01);
      box-shadow: 0 22px 58px rgba(28,18,40,.16);
    }
    .photoCard.big{ grid-column: span 7; }
    .photoCard.med{ grid-column: span 5; }
    .photoCard.small{ grid-column: span 4; }
    @media (max-width: 860px){
      .photoCard.big,.photoCard.med,.photoCard.small{ grid-column: span 12; transform:none; }
      .photoCard:hover{ transform: translateY(-2px) scale(1.01); }
    }
    .tape{
      position:absolute; top: 10px; left: 12px;
      width: 92px; height: 26px;
      background: rgba(255,90,165,.18);
      border: 1px solid rgba(255,90,165,.22);
      border-radius: 10px;
      transform: rotate(-7deg);
      box-shadow: 0 10px 22px rgba(28,18,40,.10);
      pointer-events:none;
    }
    .tape::after{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(90deg, rgba(255,255,255,.26) 0 6px, transparent 6px 12px);
      border-radius: 10px;
      opacity:.7;
    }
    .photoImgWrap{
      border-radius: 14px;
      overflow:hidden;
      border: 1px solid rgba(0,0,0,.06);
      background:#fff;
    }
    .photoImg{
      width:100%;
      height: 260px;
      object-fit: cover;
      object-position:center;
      display:block;
    }
    .photoCard.big .photoImg{ height: 300px; }
    .photoCard.small .photoImg{ height: 230px; }
    .photoText{
      margin-top: 10px;
      font-weight: 950;
      font-size: 13.8px;
    }
    .photoSub{
      margin-top: 4px;
      color: var(--mut);
      font-weight: 800;
      font-size: 12.6px;
      line-height: 1.25;
    }

    /* Mini test */
    .q{
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(0,0,0,.06);
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 16px 40px rgba(28,18,40,.10);
      display:grid;
      gap: 10px;
    }
    .q p{ margin:0; font-weight: 950; }
    .opts{ display:grid; gap:8px; }
    .opt{
      display:flex; gap:10px; align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,.06);
      background: rgba(255,255,255,.86);
      cursor:pointer;
      user-select:none;
      transition: transform .12s var(--ease), box-shadow .12s var(--ease);
    }
    .opt:hover{ transform: translateY(-1px); box-shadow: 0 12px 24px rgba(28,18,40,.10); }
    .opt input{ transform: scale(1.1); }

    .notice{
      margin-top: 10px;
      color: var(--mut);
      font-weight: 800;
      font-size: 12.7px;
      line-height: 1.35;
    }
    .result{
      margin-top: 10px;
      font-weight: 950;
    }

    /* Question (Valent√≠n) */
    .bigAsk{
      display:grid;
      gap: 12px;
      text-align:center;
    }
    .askTitle{
      font-size: 20px;
      font-weight: 1000;
      margin: 0;
    }
    .askSub{
      margin: 0;
      color: var(--mut);
      font-weight: 800;
      font-size: 13.5px;
    }
    .askBtns{
      display:flex;
      gap:10px;
      justify-content:center;
      flex-wrap:wrap;
      margin-top: 8px;
    }

    /* Lightbox */
    .lightbox{
      position: fixed;
      inset:0;
      display:none;
      z-index: 5000;
    }
    .lightbox.show{ display:block; }
    .lbBackdrop{
      position:absolute; inset:0;
      background: rgba(10,10,18,.55);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .lbCard{
      position:absolute;
      left:50%; top:50%;
      transform: translate(-50%,-50%);
      width: min(900px, 94vw);
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(255,255,255,.92);
      border-radius: 22px;
      box-shadow: 0 30px 90px rgba(0,0,0,.35);
      padding: 12px;
    }
    .lbCard img{
      width:100%;
      max-height: 72vh;
      object-fit: contain;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.06);
      background:#fff;
    }
    .lbCaption{
      margin-top: 10px;
      text-align:center;
      font-weight: 950;
    }
    .lbClose{
      position:absolute;
      top: 10px; right: 12px;
      border:1px solid rgba(0,0,0,.08);
      background: rgba(255,255,255,.88);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-weight: 1000;
    }

    /* Floating hearts */
    .hearts{
      position: fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index: 2000;
    }
    .heart{
      position:absolute;
      bottom:-20px;
      font-size: 18px;
      opacity:.85;
      animation: floatUp var(--dur) linear forwards;
      filter: drop-shadow(0 10px 18px rgba(255,90,165,.18));
    }
    @keyframes floatUp{
      from{ transform: translateY(0) translateX(0) scale(1); opacity:.85; }
      to{ transform: translateY(-110vh) translateX(var(--drift)) scale(1.15); opacity:0; }
    }

    /* Hidden screens */
    .screen{ display:none; }
    .screen.active{ display:block; }

    .row{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    .backBtn{ font-weight: 900; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="pill"><span class="dot"></span>valentine.app</div>
        <div class="pill">para <span id="whoName">Saharaim</span> üíò</div>
      </div>

      <div class="actions">
        <button id="musicBtn" class="btn">üéµ M√∫sica: OFF</button>
        <button id="heartsBtn" class="btn">üíó Corazones: ON</button>
        <button id="copyBtn" class="btn">üìã Copiar link</button>
        <button id="resetBtn" class="ghost">‚ôªÔ∏è Reset</button>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: screens -->
      <div class="panel">
        <div class="panelHeader">
          <div>
            <h1 id="title">Men√∫</h1>
            <p class="sub" id="subtitle">Todo est√° hecho para ti ‚ú®</p>
          </div>
          <div class="row">
            <button class="btn backBtn" id="backBtn" style="display:none;">‚Üê Volver</button>
          </div>
        </div>

        <div class="content">
          <!-- HOME -->
          <div class="screen active" id="home">
            <div class="menu">
              <div class="tile" data-go="letter">
                <div class="t">Carta üíå</div>
                <div class="d">Para leerla con calma (y con cari√±o).</div>
              </div>
              <div class="tile" data-go="photos">
                <div class="t">Fotos üì∏</div>
                <div class="d">Un collage con nuestros momentos.</div>
              </div>
              <div class="tile" data-go="test">
                <div class="t">Mini test üß†</div>
                <div class="d">Desbloquea la sorpresa final.</div>
              </div>
              <div class="tile locked" id="askTile" data-go="ask">
                <div class="t">Pregunta üíû</div>
                <div class="d">Se desbloquea con el mini test.</div>
              </div>
            </div>

            <p class="notice" id="homeNotice">
              Tip: si no ves cambios en tu celular, abre en inc√≥gnito o actualiza fuerte.
            </p>
          </div>

          <!-- LETTER -->
          <div class="screen" id="letter">
            <div class="letterWrap">
              <div class="paper">
                <div class="paperInner">
                  <div class="paperTitle">
                    <h2>Una carta para ti üíå</h2>
                    <span>modo: rom√°ntico</span>
                  </div>
                  <div class="letterText" id="letterText"></div>
                  <div class="sig" id="signature">Con mucho cari√±o y amor, tu hombre Sergio.</div>
                </div>
              </div>

              <div class="row">
                <button class="btn" id="replayLetterBtn">‚ú® Releer con efecto</button>
                <button class="primary" data-go="test">üß† Ir al mini test</button>
              </div>
            </div>
          </div>

          <!-- PHOTOS -->
          <div class="screen" id="photos">
            <div class="paper">
              <div class="paperInner">
                <div class="paperTitle">
                  <h2>Fotos üì∏</h2>
                  <span>t√≥calas para verlas</span>
                </div>
                <div class="photoGrid" id="photoGrid"></div>
              </div>
            </div>
            <p class="notice">Las fotos se ajustan solitas (no se estiran). Si alguna no carga, es el nombre/extensi√≥n.</p>
          </div>

          <!-- TEST -->
          <div class="screen" id="test">
            <div class="letterWrap">
              <div class="q">
                <p>1) ¬øQu√© prefiero hacer?</p>
                <div class="opts">
                  <label class="opt"><input type="radio" name="q1" value="gym"> Ir al gym</label>
                  <label class="opt"><input type="radio" name="q1" value="escuela"> Ir a la escuela</label>
                  <label class="opt"><input type="radio" name="q1" value="videojuegos"> Jugar videojuegos</label>
                </div>
              </div>

              <div class="q">
                <p>2) ¬øQu√© estilo de moto prefiero?</p>
                <div class="opts">
                  <label class="opt"><input type="radio" name="q2" value="naked"> Naked</label>
                  <label class="opt"><input type="radio" name="q2" value="deportiva"> Deportiva</label>
                  <label class="opt"><input type="radio" name="q2" value="2t"> Dos tiempos</label>
                </div>
              </div>

              <div class="q">
                <p>3) ¬øMe amas?</p>
                <div class="opts">
                  <label class="opt"><input type="radio" name="q3" value="si"> S√≠</label>
                  <label class="opt"><input type="radio" name="q3" value="no"> No</label>
                </div>
              </div>

              <div class="row">
                <button class="primary" id="submitTestBtn">Enviar üíå</button>
                <button class="btn" id="clearTestBtn">Borrar respuestas</button>
              </div>

              <div class="result" id="testResult"></div>
              <p class="notice">Cuando lo completes bien, se desbloquea ‚ÄúPregunta‚Äù en el men√∫.</p>
            </div>
          </div>

          <!-- ASK -->
          <div class="screen" id="ask">
            <div class="paper">
              <div class="paperInner bigAsk">
                <p class="askSub">Ok, lleg√≥ el momento serio (pero cute) ü´£</p>
                <h2 class="askTitle" id="askTitle">¬øQuieres ser mi San Valent√≠n? üíò</h2>
                <p class="askSub">Prometo hacerte feliz (y no solo en commits).</p>

                <div class="askBtns">
                  <button class="primary" id="yesBtn">S√≠ üíñ</button>
                  <button class="btn" id="noBtn">No üôÉ</button>
                </div>

                <div class="result" id="askResult"></div>
                <p class="notice">P.D. Si dices que s√≠, hay confeti. Si dices que no‚Ä¶ igual te respeto üòå</p>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT: small info card -->
      <div class="panel">
        <div class="panelHeader">
          <div>
            <h1>Detalles</h1>
            <p class="sub">Todo pensado para celular üì±</p>
          </div>
        </div>
        <div class="content">
          <div class="paper">
            <div class="paperInner">
              <p style="margin:0;font-weight:950;">Checklist ‚úÖ</p>
              <p class="notice" style="margin:10px 0 0;">
                ‚Ä¢ Carta (con efecto) <br>
                ‚Ä¢ Fotos (collage) <br>
                ‚Ä¢ Mini test (bloqueo real) <br>
                ‚Ä¢ Pregunta final <br>
                ‚Ä¢ M√∫sica ON/OFF <br>
                ‚Ä¢ Corazones ON/OFF <br>
              </p>
              <p class="notice" style="margin:12px 0 0;">
                Si quieres, luego metemos: mini juego, timeline, o ‚Äú√°lbum‚Äù con swipe.
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hearts -->
  <div class="hearts" id="heartsLayer" aria-hidden="true"></div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lbBackdrop" id="lbBackdrop"></div>
    <div class="lbCard" role="dialog" aria-modal="true">
      <button class="lbClose" id="lbClose" aria-label="Cerrar">‚úï</button>
      <img id="lbImg" alt="Foto" />
      <div class="lbCaption" id="lbCaption"></div>
    </div>
  </div>

  <!-- Audio (upload your file to assets/music.mp3) -->
  <audio id="bgMusic" loop preload="auto">
    <source src="assets/music.mp3" type="audio/mpeg">
  </audio>

  <script>
    "use strict";

    /* ==========================
       EDITA AQU√ç (cuando quieras)
    ========================== */

    // 1) Nombre
    const GIRL_NAME = "Saharaim";

    // 2) Carta (pon aqu√≠ TU texto cuando me lo mandes)
    //    Nota: el efecto SIEMPRE usar√° este mismo texto (0 random).
    const LETTER_TEXT =
`Hola ${GIRL_NAME} üíó

(Aqu√≠ va tu carta real. Cuando me la mandes, la pego tal cual.)

Me encantas por mil cosas, pero sobre todo por c√≥mo haces que todo se sienta m√°s bonito cuando est√°s conmigo.

Gracias por ser t√∫.
`;

    // 3) Fotos (ya est√°n en assets/photos)
    const PHOTOS = [
      { src: "assets/photos/01.jpeg", title: "Recuerdo 1 üíò", sub: "Pon aqu√≠ tu frase corta." },
      { src: "assets/photos/02.png",  title: "Recuerdo 2 ‚ú®", sub: "Pon aqu√≠ tu frase corta." },
      { src: "assets/photos/03.jpeg", title: "Recuerdo 3 ü´∂", sub: "Pon aqu√≠ tu frase corta." },
      { src: "assets/photos/04.jpeg", title: "Recuerdo 4 üå∏", sub: "Pon aqu√≠ tu frase corta." },
      { src: "assets/photos/05.png",  title: "Recuerdo 5 ü•∫", sub: "Pon aqu√≠ tu frase corta." },
    ];

    // 4) Pregunta final (puedes cambiar el texto)
    const ASK_TEXT = "¬øQuieres ser mi San Valent√≠n? üíò";

    // 5) Respuestas correctas del mini test
    const ANSWERS = { q1: "gym", q2: "naked", q3: "si" };

    /* ==========================
       Estado y utilidades
    ========================== */

    const LS = {
      testPassed: "val_test_passed_v1",
      heartsOn: "val_hearts_on_v1",
      musicOn: "val_music_on_v1"
    };

    const $ = (id) => document.getElementById(id);

    function safeText(el, text){
      if(!el) return;
      el.textContent = text;
    }

    function setTitle(main, sub){
      safeText($("title"), main);
      safeText($("subtitle"), sub || "");
    }

    function showBack(show){
      const b = $("backBtn");
      if(!b) return;
      b.style.display = show ? "inline-flex" : "none";
    }

    function go(screenId){
      // hide all
      document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
      const s = $(screenId);
      if(s) s.classList.add("active");

      // titles
      if(screenId === "home"){
        setTitle("Men√∫", "Todo est√° hecho para ti ‚ú®");
        showBack(false);
      } else {
        const map = {
          letter: ["Carta", "Con calma, como se merece üíå"],
          photos: ["Fotos", "Nuestros momentos üì∏"],
          test:   ["Mini test", "Desbloquea la sorpresa üß†"],
          ask:    ["Pregunta", "Ok‚Ä¶ aqu√≠ viene lo bueno üíû"]
        };
        const t = map[screenId] || ["", ""];
        setTitle(t[0], t[1]);
        showBack(true);
      }

      // when entering photos, ensure rendered
      if(screenId === "photos") renderPhotos();
      if(screenId === "letter") renderLetterStatic();
      if(screenId === "ask") safeText($("askTitle"), ASK_TEXT);
      if(screenId === "test") updateAskLockUI();
    }

    function copyLink(){
      const url = window.location.href;
      navigator.clipboard?.writeText(url).then(()=>{
        toast("Link copiado ‚úÖ");
      }).catch(()=>{
        // fallback
        const ta = document.createElement("textarea");
        ta.value = url; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy");
        ta.remove();
        toast("Link copiado ‚úÖ");
      });
    }

    function toast(msg){
      // simple mini toast
      const t = document.createElement("div");
      t.textContent = msg;
      t.style.position="fixed";
      t.style.left="50%";
      t.style.bottom="22px";
      t.style.transform="translateX(-50%)";
      t.style.padding="10px 14px";
      t.style.borderRadius="999px";
      t.style.background="rgba(255,255,255,.92)";
      t.style.border="1px solid rgba(0,0,0,.08)";
      t.style.boxShadow="0 18px 50px rgba(0,0,0,.20)";
      t.style.fontWeight="950";
      t.style.zIndex="99999";
      t.style.backdropFilter="blur(10px)";
      document.body.appendChild(t);
      setTimeout(()=>{ t.style.opacity="0"; t.style.transition="opacity .25s"; }, 1200);
      setTimeout(()=> t.remove(), 1600);
    }

    /* ==========================
       Carta (sin bugs)
    ========================== */

    let typingTimer = null;
    let isTyping = false;

    function renderLetterStatic(){
      // Always set the same text, no randomness
      const el = $("letterText");
      if(!el) return;
      // stop any active typing cleanly
      if(typingTimer){ clearInterval(typingTimer); typingTimer = null; }
      isTyping = false;
      el.textContent = LETTER_TEXT.trim();
      safeText($("signature"), "Con mucho cari√±o y amor, tu hombre Sergio.");
    }

    function typeLetter(){
      const el = $("letterText");
      if(!el) return;
      if(isTyping) return; // prevents spam-click bugs

      // reset and type same LETTER_TEXT always
      if(typingTimer){ clearInterval(typingTimer); typingTimer = null; }
      el.textContent = "";
      isTyping = true;

      const text = LETTER_TEXT.trim();
      let i = 0;

      typingTimer = setInterval(()=>{
        // defensive
        if(!el){ clearInterval(typingTimer); typingTimer=null; isTyping=false; return; }

        el.textContent += text[i] || "";
        i++;

        // auto-scroll inside paper (nice on mobile)
        el.parentElement?.scrollIntoView({ block:"nearest" });

        if(i >= text.length){
          clearInterval(typingTimer);
          typingTimer = null;
          isTyping = false;
          safeText($("signature"), "Con mucho cari√±o y amor, tu hombre Sergio.");
        }
      }, 18);
    }

    /* ==========================
       Fotos
    ========================== */

    function renderPhotos(){
      const grid = $("photoGrid");
      if(!grid) return;
      grid.innerHTML = "";

      const sizes = ["big","med","small","med","big"];
      const tilts = ["-1.2deg","1deg","-0.6deg","0.8deg","-1deg"];

      PHOTOS.forEach((p, i)=>{
        const card = document.createElement("div");
        card.className = `photoCard ${sizes[i] || "med"}`;
        card.style.setProperty("--tilt", tilts[i] || "0deg");

        card.innerHTML = `
          <span class="tape"></span>
          <div class="photoImgWrap">
            <img class="photoImg" src="${p.src}" alt="Foto ${i+1}" loading="lazy">
          </div>
          <div class="photoText">${escapeHtml(p.title)}</div>
          <div class="photoSub">${escapeHtml(p.sub || "")}</div>
        `;

        card.addEventListener("click", ()=> openLightbox(p.src, `${p.title}${p.sub ? " ‚Äî " + p.sub : ""}`));
        grid.appendChild(card);
      });
    }

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function openLightbox(src, caption){
      const lb = $("lightbox");
      const img = $("lbImg");
      const cap = $("lbCaption");
      if(!lb || !img || !cap) return;
      img.src = src;
      cap.textContent = caption || "";
      lb.classList.add("show");
      lb.setAttribute("aria-hidden","false");
    }

    function closeLightbox(){
      const lb = $("lightbox");
      if(!lb) return;
      lb.classList.remove("show");
      lb.setAttribute("aria-hidden","true");
    }

    /* ==========================
       Mini test + bloqueo real
    ========================== */

    function getAnswer(name){
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : null;
    }

    function clearAnswers(){
      ["q1","q2","q3"].forEach(q=>{
        document.querySelectorAll(`input[name="${q}"]`).forEach(i => i.checked = false);
      });
    }

    function testPassed(){
      return localStorage.getItem(LS.testPassed) === "true";
    }

    function setTestPassed(v){
      localStorage.setItem(LS.testPassed, v ? "true" : "false");
    }

    function updateAskLockUI(){
      const locked = !testPassed();
      const tile = $("askTile");
      if(tile){
        tile.classList.toggle("locked", locked);
      }
      // subtitle notice
      const n = $("homeNotice");
      if(n){
        n.textContent = locked
          ? "Completa el mini test para desbloquear la Pregunta üíû"
          : "Pregunta desbloqueada ‚úÖ (ya puedes entrar)";
      }
    }

    function tryOpenAsk(){
      if(testPassed()){
        go("ask");
      } else {
        toast("Primero completa el mini test üß†");
        go("test");
      }
    }

    function submitTest(){
      const r = $("testResult");
      const a1 = getAnswer("q1");
      const a2 = getAnswer("q2");
      const a3 = getAnswer("q3");

      if(!a1 || !a2 || !a3){
        if(r) r.textContent = "Responde todas las preguntas üò≥";
        return;
      }

      const ok = (a1 === ANSWERS.q1 && a2 === ANSWERS.q2 && a3 === ANSWERS.q3);

      if(ok){
        setTestPassed(true);
        if(r) r.textContent = "Correcto üíñ Se desbloque√≥ la secci√≥n ‚ÄúPregunta‚Äù.";
        updateAskLockUI();
        // little celebration
        burstHearts(18);
        setTimeout(()=> go("home"), 600);
      } else {
        setTestPassed(false); // IMPORTANT: ensure lock stays if wrong
        updateAskLockUI();
        if(r) r.textContent = "Mmm‚Ä¶ intenta otra vez üëÄ";
      }
    }

    /* ==========================
       Pregunta final (s√≠ / no)
       (con respeto, sin coerci√≥n)
    ========================== */

    function onYes(){
      const r = $("askResult");
      if(r) r.textContent = "AAAAA üò≠üíò Sab√≠a que s√≠. (Confirmado: eres mi persona favorita).";
      burstHearts(30);
      toast("Felicidades: aceptaste üíñ");
    }

    function onNo(){
      const r = $("askResult");
      if(r) r.textContent = "Ok üòå Te respeto. Igual gracias por existir en mi vida üíó";
      toast("Todo bien ü´∂");
    }

    /* ==========================
       Corazones ON/OFF
    ========================== */

    function heartsOn(){
      return localStorage.getItem(LS.heartsOn) !== "false"; // default ON
    }
    function setHeartsOn(v){
      localStorage.setItem(LS.heartsOn, v ? "true" : "false");
      updateHeartsBtn();
      if(v) burstHearts(10);
    }

    function updateHeartsBtn(){
      const b = $("heartsBtn");
      if(!b) return;
      b.textContent = heartsOn() ? "üíó Corazones: ON" : "üíó Corazones: OFF";
    }

    function burstHearts(count){
      if(!heartsOn()) return;
      const layer = $("heartsLayer");
      if(!layer) return;

      for(let i=0;i<count;i++){
        const h = document.createElement("div");
        h.className = "heart";
        h.textContent = ["üíó","üíò","üíï","üíû","üå∏","‚ú®"][Math.floor(Math.random()*6)];
        h.style.left = Math.random()*100 + "vw";
        h.style.setProperty("--dur", (3.2 + Math.random()*2.0) + "s");
        h.style.setProperty("--drift", ((Math.random()*140)-70) + "px");
        h.style.fontSize = (16 + Math.random()*16) + "px";
        h.style.opacity = (0.65 + Math.random()*0.25).toFixed(2);
        layer.appendChild(h);
        setTimeout(()=> h.remove(), 6200);
      }
    }

    /* ==========================
       M√∫sica ON/OFF (assets/music.mp3)
    ========================== */

    function musicOn(){
      return localStorage.getItem(LS.musicOn) === "true";
    }
    function setMusicOn(v){
      localStorage.setItem(LS.musicOn, v ? "true" : "false");
      updateMusicBtn();
      toggleMusic(v);
    }

    function updateMusicBtn(){
      const b = $("musicBtn");
      if(!b) return;
      b.textContent = musicOn() ? "üéµ M√∫sica: ON" : "üéµ M√∫sica: OFF";
    }

    async function toggleMusic(on){
      const audio = $("bgMusic");
      if(!audio) return;

      if(!on){
        try{ audio.pause(); }catch(_){}
        return;
      }

      // Browsers require user interaction to play audio.
      try{
        await audio.play();
      } catch(err){
        // If blocked, show a helpful toast (no scary errors)
        toast("Toca otra vez ‚ÄúM√∫sica‚Äù para activar üéµ");
        setMusicOn(false);
      }
    }

    /* ==========================
       Reset total (para pruebas)
    ========================== */

    function hardReset(){
      localStorage.removeItem(LS.testPassed);
      localStorage.removeItem(LS.heartsOn);
      localStorage.removeItem(LS.musicOn);
      // stop music
      const audio = $("bgMusic");
      if(audio) { try{ audio.pause(); audio.currentTime = 0; }catch(_){ } }
      clearAnswers();
      const tr = $("testResult"); if(tr) tr.textContent = "";
      const ar = $("askResult"); if(ar) ar.textContent = "";
      updateAskLockUI();
      updateHeartsBtn();
      updateMusicBtn();
      renderLetterStatic();
      go("home");
      toast("Reset listo ‚ôªÔ∏è");
    }

    /* ==========================
       Wiring (event listeners)
    ========================== */

    function wire(){
      // menu tiles
      document.querySelectorAll("[data-go]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const target = el.getAttribute("data-go");
          if(target === "ask") { tryOpenAsk(); return; }
          go(target);
        });
      });

      // back
      const back = $("backBtn");
      if(back) back.addEventListener("click", ()=> go("home"));

      // top buttons
      $("copyBtn")?.addEventListener("click", copyLink);
      $("resetBtn")?.addEventListener("click", hardReset);

      // letter
      $("replayLetterBtn")?.addEventListener("click", ()=> typeLetter());

      // test
      $("submitTestBtn")?.addEventListener("click", submitTest);
      $("clearTestBtn")?.addEventListener("click", ()=>{
        clearAnswers();
        const tr = $("testResult"); if(tr) tr.textContent = "";
        toast("Listo üòº");
      });

      // ask
      $("yesBtn")?.addEventListener("click", onYes);
      $("noBtn")?.addEventListener("click", onNo);

      // hearts toggle
      $("heartsBtn")?.addEventListener("click", ()=>{
        setHeartsOn(!heartsOn());
      });

      // music toggle
      $("musicBtn")?.addEventListener("click", ()=>{
        setMusicOn(!musicOn());
      });

      // lightbox close
      $("lbBackdrop")?.addEventListener("click", closeLightbox);
      $("lbClose")?.addEventListener("click", closeLightbox);
      document.addEventListener("keydown", (e)=>{ if(e.key === "Escape") closeLightbox(); });
    }

    /* ==========================
       Init
    ========================== */

    function init(){
      safeText($("whoName"), GIRL_NAME);
      safeText($("askTitle"), ASK_TEXT);

      // initial state
      updateAskLockUI();
      updateHeartsBtn();
      updateMusicBtn();

      // letter must be stable always
      renderLetterStatic();

      // render photos once (and again when entering)
      renderPhotos();

      // If test was previously passed, keep it unlocked
      updateAskLockUI();

      wire();

      // optional: soft hearts on load
      setTimeout(()=> burstHearts(8), 450);

      // If music saved ON, try play only after user click (browser rule)
      // We'll keep button state; user can tap once.
    }

    init();
  </script>
</body>
</html>
