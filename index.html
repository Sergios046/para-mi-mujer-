<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Para Saharaim ğŸ’—</title>
  <style>
    :root{
      --bg1:#fff7fb;
      --bg2:#f3edff;
      --card: rgba(255,255,255,.72);
      --stroke: rgba(140,120,160,.20);
      --text:#2b2433;
      --muted: rgba(43,36,51,.65);
      --shadow: 0 14px 50px rgba(30,18,44,.12);
      --shadow2: 0 10px 30px rgba(30,18,44,.10);
      --r: 22px;
      --pad: 18px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,168,213,.28), transparent 60%),
        radial-gradient(900px 600px at 80% 15%, rgba(179,151,255,.25), transparent 55%),
        linear-gradient(135deg, var(--bg1), var(--bg2));
      overflow-x:hidden;
    }

    /* Background photo */
    .bg-photo{
      position:fixed; inset:0;
      z-index:-3;
      background-image: url("assets/photos/06.jpeg");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      filter: blur(6px) saturate(1.05) contrast(1.03);
      opacity: .35;
      transform: scale(1.03);
      pointer-events:none;
    }
    .bg-overlay{
      position:fixed; inset:0; z-index:-2;
      background: linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.78));
      pointer-events:none;
    }

    /* Hearts */
    .hearts-layer{
      position:fixed; inset:0; z-index:-1;
      pointer-events:none;
      overflow:hidden;
    }
    .heart{
      position:absolute;
      font-size: 18px;
      opacity:0;
      transform: translateY(30px) scale(1);
      animation: floatUp linear forwards;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.10));
    }
    @keyframes floatUp{
      0%{ opacity:0; transform: translateY(30px) scale(.95); }
      12%{ opacity:.95; }
      100%{ opacity:0; transform: translateY(-110vh) scale(1.1); }
    }

    /* Top bar */
    .topbar{
      max-width: 1100px;
      margin: 18px auto 0;
      padding: 0 14px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .pill .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(140,120,160,.16);
      font-size: 13px;
      color: rgba(43,36,51,.78);
      white-space: nowrap;
    }
    .top-actions{
      display:flex; gap:10px; flex-wrap: wrap;
      justify-content:flex-end;
    }
    .btn{
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: rgba(255,255,255,.78);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      font-weight: 700;
      color: rgba(43,36,51,.82);
      transition: transform .15s ease, box-shadow .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 26px rgba(30,18,44,.14); }
    .btn:active{ transform: translateY(0px) scale(.98); }
    .btn .state{
      font-size: 12px;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(90,160,120,.25);
      background: rgba(90,200,140,.12);
      color: rgba(30,120,70,.95);
    }
    .btn.off .state{
      border-color: rgba(180,110,140,.25);
      background: rgba(255,120,170,.10);
      color: rgba(160,60,110,.95);
    }

    /* Layout */
    .wrap{
      max-width:1100px;
      margin: 14px auto 36px;
      padding: 0 14px;
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
      padding: var(--pad);
    }
    .card h2{ margin: 0 0 2px 0; font-size: 18px; letter-spacing: .2px; }
    .sub{ margin: 0 0 14px 0; color: var(--muted); font-size: 13px; }

    /* Menu */
    .menu-grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 680px){
      .menu-grid{ grid-template-columns: 1fr 1fr; }
    }
    .tile{
      position:relative;
      padding: 14px 12px;
      border-radius: 18px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.64);
      box-shadow: 0 10px 24px rgba(30,18,44,.08);
      cursor:pointer;
      transition: transform .16s ease, box-shadow .16s ease;
      min-height: 86px;
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
    }
    .tile:hover{ transform: translateY(-1px); box-shadow: 0 14px 28px rgba(30,18,44,.10); }
    .tile:active{ transform: translateY(0px) scale(.99); }
    .tile .t-title{ display:flex; gap:8px; align-items:center; font-weight: 950; margin-bottom: 6px; }
    .tile .t-desc{ font-size: 12px; color: rgba(43,36,51,.62); font-weight: 650; line-height: 1.25; }

    .tile.locked{ opacity: .62; cursor:not-allowed; }
    .tile.locked::after{
      content:"ğŸ”’ Bloqueado";
      position:absolute;
      top: 10px;
      right: 10px;
      font-size: 11px;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(140,120,160,.16);
      color: rgba(160,60,110,.78);
    }

    /* Section header */
    .section-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      flex-wrap:wrap;
      margin-bottom: 8px;
    }
    .crumb{ display:flex; gap:10px; align-items:center; font-weight: 950; font-size: 15px; }
    .back{
      display:inline-flex; align-items:center; gap: 8px;
      padding: 9px 12px;
      border-radius: 999px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.62);
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
      transition: transform .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .back:hover{ transform: translateY(-1px); }
    .hint-badge{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px dashed rgba(155,125,255,.35);
      background: rgba(155,125,255,.10);
      color: rgba(80,60,140,.88);
      font-weight: 900;
    }

    /* Paper */
    .paper{
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(140,120,160,.16);
      border-radius: 20px;
      padding: 16px;
      box-shadow: 0 10px 24px rgba(30,18,44,.08);
      position:relative;
      overflow:hidden;
    }
    .paper::before, .paper::after{ pointer-events:none; }
    .paper::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 120px at 20% 12%, rgba(255,170,210,.28), transparent 55%),
        radial-gradient(600px 120px at 80% 18%, rgba(175,150,255,.25), transparent 55%),
        linear-gradient(90deg, rgba(240,230,255,.25), rgba(255,230,245,.22));
      opacity:.9;
      z-index:0;
    }
    .paper::after{
      content:"";
      position:absolute; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(120,90,160,.06) 0px,
        rgba(120,90,160,.06) 1px,
        transparent 1px,
        transparent 28px
      );
      opacity:.65;
      z-index:0;
      mix-blend-mode:multiply;
    }
    .paper-inner{
      position:relative; z-index:1;
      white-space:pre-wrap;
      line-height: 1.45;
      font-size: 14px;
      color: rgba(43,36,51,.88);
      font-weight: 650;
    }
    .paper-sign{
      position:relative; z-index:1;
      margin-top: 10px;
      font-weight: 950;
      color: rgba(43,36,51,.82);
    }
    .letter-actions{
      margin-top: 12px;
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      position:relative;
      z-index:2;
    }
    .mini-btn{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.74);
      font-weight: 950;
      font-size: 13px;
      transition: transform .15s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .mini-btn:hover{ transform: translateY(-1px); }

    .surprise{
      display:none;
      margin-top: 12px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(255,120,190,.25);
      background: rgba(255,255,255,.70);
      box-shadow: 0 10px 24px rgba(30,18,44,.08);
      position:relative;
      z-index:2;
    }
    .surprise .s-title{ font-weight: 1000; margin-bottom: 6px; }
    .surprise .s-text{ color: rgba(43,36,51,.70); font-weight: 750; font-size: 13px; }

    .note{
      display:none;
      margin-top: 10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.78);
      box-shadow: 0 10px 22px rgba(30,18,44,.10);
      font-weight: 1000;
      text-align:center;
    }
    .note .big{
      font-size: 18px;
      letter-spacing: 1px;
      margin-bottom: 10px;
    }

    /* Photos */
    .collage{
      display:grid;
      grid-template-columns: 1.25fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 680px){
      .collage{ grid-template-columns: 1fr; }
    }
    .col{ display:flex; flex-direction:column; gap: 12px; }
    .photo{
      position:relative;
      border-radius: 22px;
      overflow:hidden;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.55);
      box-shadow: 0 12px 28px rgba(30,18,44,.10);
      transform: translateZ(0);
      -webkit-tap-highlight-color: transparent;
    }
    /* IMPORTANT: siempre completa */
    .photo img{
      width:100%;
      height:100%;
      object-fit: contain;
      object-position: center;
      display:block;
      background: rgba(255,255,255,.22);
      transition: transform .22s ease;
      transform: scale(1);
      padding: 10px;
    }
    .photo:hover img{ transform: scale(1.02); }

    .cap{
      position:absolute;
      left: 10px; right: 10px; bottom: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.78);
      border: 1px solid rgba(140,120,160,.16);
      color: rgba(43,36,51,.80);
      font-weight: 900;
      font-size: 13px;
      line-height: 1.25;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 22px rgba(30,18,44,.10);
    }
    .tap-hint{
      font-size: 12px;
      color: rgba(43,36,51,.55);
      margin-top: 12px;
      font-weight: 750;
    }
    .pop-heart{
      position:absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%) scale(.6);
      font-size: 52px;
      opacity:0;
      pointer-events:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.18));
      animation: popHeart .65s ease forwards;
      z-index: 3;
    }
    @keyframes popHeart{
      0%{ opacity:0; transform: translate(-50%,-50%) scale(.5); }
      25%{ opacity:1; transform: translate(-50%,-55%) scale(1.05); }
      100%{ opacity:0; transform: translate(-50%,-80%) scale(1.2); }
    }

    /* Quiz */
    .quiz{ margin-top: 10px; display:flex; flex-direction:column; gap: 12px; }
    .q{
      border-radius: 18px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.65);
      padding: 12px;
      box-shadow: 0 10px 22px rgba(30,18,44,.08);
    }
    .q h3{ margin: 0 0 10px 0; font-size: 14px; font-weight: 950; }
    .opts{ display:flex; gap: 8px; flex-wrap:wrap; }
    .opt{
      cursor:pointer;
      border-radius: 999px;
      padding: 10px 12px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.74);
      font-weight: 900;
      font-size: 13px;
      transition: transform .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .opt:hover{ transform: translateY(-1px); }
    .opt.selected{
      border-color: rgba(155,125,255,.35);
      background: rgba(155,125,255,.10);
      color: rgba(80,60,140,.92);
    }
    .quiz-actions{ display:flex; gap: 10px; flex-wrap:wrap; margin-top: 4px; }
    .toast{
      margin-top: 10px;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.68);
      font-weight: 900;
      color: rgba(43,36,51,.78);
      display:none;
    }
    .toast.good{
      border-color: rgba(90,200,140,.22);
      background: rgba(90,200,140,.10);
      color: rgba(35,120,75,.88);
    }
    .toast.bad{
      border-color: rgba(255,120,170,.22);
      background: rgba(255,120,170,.10);
      color: rgba(160,60,110,.90);
    }

    /* Final ask */
    .final{
      margin-top: 10px;
      padding: 14px;
      border-radius: 20px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.68);
      box-shadow: 0 12px 28px rgba(30,18,44,.10);
      position: relative;
      overflow: hidden;
    }
    .final h3{ margin: 0 0 6px 0; font-size: 16px; font-weight: 1000; }
    .final p{ margin: 0 0 14px 0; color: rgba(43,36,51,.65); font-weight: 650; font-size: 13px; }
    .yn{ display:flex; gap: 10px; flex-wrap:wrap; }
    .yes, .no{
      cursor:pointer;
      border-radius: 999px;
      padding: 12px 14px;
      border: 1px solid rgba(140,120,160,.16);
      background: rgba(255,255,255,.78);
      font-weight: 1000;
      font-size: 14px;
      transition: transform .15s ease;
      position:relative;
      z-index: 2;
      -webkit-tap-highlight-color: transparent;
    }
    .yes:hover, .no:hover{ transform: translateY(-1px); }
    .final-msg{
      margin-top: 12px;
      font-weight: 1000;
      display:none;
      padding: 12px;
      border-radius: 16px;
      border: 1px solid rgba(90,200,140,.22);
      background: rgba(90,200,140,.10);
      color: rgba(35,120,75,.88);
    }

    /* Controls panel */
    .controls-panel .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      padding: 12px;
      border-radius: 18px;
      border: 1px solid rgba(140,120,160,.14);
      background: rgba(255,255,255,.62);
      margin-top: 10px;
    }
    .controls-panel .label{ display:flex; align-items:center; gap:10px; font-weight: 950; color: rgba(43,36,51,.82); }
    .toggle{
      width: 54px; height: 30px;
      border-radius: 999px;
      background: rgba(140,120,160,.16);
      border: 1px solid rgba(140,120,160,.12);
      position:relative;
      cursor:pointer;
      flex: 0 0 auto;
      transition: background .2s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .knob{
      width: 26px; height: 26px;
      border-radius: 50%;
      background: rgba(255,255,255,.95);
      border: 1px solid rgba(140,120,160,.16);
      position:absolute;
      top: 1px; left: 1px;
      transition: left .2s ease;
      box-shadow: 0 10px 20px rgba(30,18,44,.10);
    }
    .toggle.on{ background: rgba(90,200,140,.28); border-color: rgba(90,200,140,.22); }
    .toggle.on .knob{ left: 27px; }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-weight: 950;
      font-size: 12px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(140,120,160,.14);
      background: rgba(255,255,255,.62);
      color: rgba(43,36,51,.74);
      white-space: nowrap;
    }
    .status-pill.good{
      border-color: rgba(90,200,140,.22);
      background: rgba(90,200,140,.10);
      color: rgba(35,120,75,.88);
    }
    .status-pill.bad{
      border-color: rgba(255,120,170,.22);
      background: rgba(255,120,170,.10);
      color: rgba(160,60,110,.90);
    }

    /* Progress */
    .progress-wrap{
      margin-top: 12px;
      padding: 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.62);
      border: 1px solid rgba(140,120,160,.14);
    }
    .progress-top{
      display:flex; align-items:center; justify-content:space-between;
      gap: 10px; flex-wrap:wrap; margin-bottom:10px;
    }
    .prog-title{ font-weight: 1000; font-size: 13px; color: rgba(43,36,51,.82); }
    .prog-percent{ font-size: 12px; color: rgba(43,36,51,.62); font-weight: 900; }
    .bar{
      height: 10px; border-radius: 999px;
      background: rgba(140,120,160,.14);
      overflow:hidden;
      border: 1px solid rgba(140,120,160,.10);
    }
    .bar > div{
      height:100%; width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,120,190,.55), rgba(155,125,255,.55));
      transition: width .35s ease;
    }
    .steps{
      margin-top: 10px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    @media (max-width: 520px){ .steps{ grid-template-columns: 1fr 1fr; } }
    .step{
      display:flex; align-items:center; gap: 8px;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(140,120,160,.14);
      background: rgba(255,255,255,.55);
      font-size: 12.5px;
      color: rgba(43,36,51,.70);
      font-weight: 800;
    }
    .dot{
      width: 10px; height: 10px;
      border-radius: 50%;
      background: rgba(140,120,160,.25);
      border: 1px solid rgba(140,120,160,.15);
      flex: 0 0 auto;
    }
    .step.done{
      background: rgba(90,200,140,.10);
      border-color: rgba(90,200,140,.20);
      color: rgba(35,120,75,.88);
    }
    .step.done .dot{
      background: rgba(90,200,140,.65);
      border-color: rgba(90,200,140,.25);
    }

    /* Fullscreen (UI mode) */
    .fullscreen .controls-panel{ display:none; }
    .fullscreen .wrap{ grid-template-columns: 1fr; }

    .fade-in{ animation: fadeIn .25s ease both; }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="bg-photo"></div>
  <div class="bg-overlay"></div>
  <div class="hearts-layer" id="heartsLayer"></div>

  <div class="topbar">
    <div class="pill">
      <div class="tag">ğŸ’— <b>para Saharaim</b></div>
      <div class="tag">âœ¨ hecho por Sergio</div>
    </div>

    <div class="top-actions">
      <div class="btn" id="btnMusic">ğŸµ MÃºsica <span class="state" id="musicState">OFF</span></div>
      <div class="btn" id="btnHearts">ğŸ’ Corazones <span class="state" id="heartsState">ON</span></div>
      <div class="btn" id="btnConfetti">ğŸ‰ Confetti <span class="state" id="confettiState">GO</span></div>
      <div class="btn" id="btnFullscreen">ğŸ“± Pantalla <span class="state" id="fsState">FULL</span></div>
      <div class="btn" id="btnCopy">ğŸ”— Copiar link</div>
      <div class="btn off" id="btnReset">ğŸ§¼ Reset</div>
    </div>
  </div>

  <div class="wrap" id="app">
    <div class="card" id="mainCard">
      <div id="view"></div>
    </div>

    <div class="card controls-panel" id="controlsPanel">
      <h2>Controles</h2>
      <p class="sub">Todo pensado para celular ğŸ“±</p>

      <div class="row">
        <div class="label">ğŸµ MÃºsica</div>
        <div class="toggle" id="toggleMusic"><div class="knob"></div></div>
      </div>

      <div class="row">
        <div class="label">ğŸ’ Corazones</div>
        <div class="toggle on" id="toggleHearts"><div class="knob"></div></div>
      </div>

      <div class="row">
        <div class="label">ğŸ‰ Confetti</div>
        <div class="mini-btn" id="ctrlConfetti">Lanzar</div>
      </div>

      <div class="row">
        <div class="label">ğŸ”— Copiar link</div>
        <div class="status-pill">1 toque</div>
      </div>

      <div class="row">
        <div class="label">ğŸ§¼ Reset</div>
        <div class="status-pill bad">borra progreso</div>
      </div>

      <div class="row" style="justify-content:space-between;">
        <div class="label">ğŸ“Œ Estado</div>
        <div id="statusPill" class="status-pill bad">Pregunta: bloqueada</div>
      </div>

      <div class="progress-wrap">
        <div class="progress-top">
          <div class="prog-title">Progreso ğŸ’—</div>
          <div class="prog-percent" id="progPercent">0%</div>
        </div>
        <div class="bar"><div id="progBar"></div></div>
        <div class="steps">
          <div class="step" id="sLetter"><div class="dot"></div> Carta</div>
          <div class="step" id="sPhotos"><div class="dot"></div> Fotos</div>
          <div class="step" id="sQuiz"><div class="dot"></div> Mini test</div>
          <div class="step" id="sAsk"><div class="dot"></div> Pregunta</div>
        </div>
      </div>
    </div>
  </div>

  <audio id="audio" preload="auto" loop>
    <source src="assets/photos/music.mp3" type="audio/mpeg">
  </audio>

  <script>
    // âœ… Polyfill clone (no structuredClone)
    function clone(obj){ return JSON.parse(JSON.stringify(obj)); }

    const LS_KEY = "valentine_state_v5";
    const defaultState = {
      visited: { home:true, letter:false, photos:false, quiz:false, ask:false },
      quizPassed: false,
      askUnlocked: false,
      heartsOn: true,
      musicOn: false,
      fullscreen: false
    };

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return clone(defaultState);
        const s = JSON.parse(raw);
        const base = clone(defaultState);
        base.visited = Object.assign({}, base.visited, (s.visited||{}));
        return Object.assign(base, s);
      }catch{
        return clone(defaultState);
      }
    }

    let state = loadState();

    const $ = (id)=>document.getElementById(id);

    document.addEventListener("DOMContentLoaded", ()=>{
      const view = $("view");
      const audio = $("audio");
      const heartsLayer = $("heartsLayer");

      /* Hearts */
      let heartsTimer = null;

      function clearHearts(){ heartsLayer.innerHTML = ""; }

      function spawnHeart(){
        if(!state.heartsOn) return;
        const heart = document.createElement("div");
        heart.className = "heart";
        const hearts = ["ğŸ’—","ğŸ’","ğŸ’–","ğŸ’˜","â¤ï¸","ğŸ’“"];
        heart.textContent = hearts[Math.floor(Math.random()*hearts.length)];
        const size = 14 + Math.random()*16;
        heart.style.fontSize = size + "px";
        heart.style.left = (Math.random()*100) + "vw";
        heart.style.bottom = (-20 - Math.random()*30) + "px";
        const dur = 6 + Math.random()*5;
        heart.style.animationDuration = dur + "s";
        heartsLayer.appendChild(heart);
        setTimeout(()=> heart.remove(), (dur+1)*1000);
      }

      function startHearts(){
        if(!state.heartsOn) return;
        if(heartsTimer) return;
        heartsTimer = setInterval(spawnHeart, 450);
      }

      function stopHearts(){
        if(heartsTimer){
          clearInterval(heartsTimer);
          heartsTimer = null;
        }
      }

      function heartBurst(){
        if(!state.heartsOn) return;
        for(let i=0;i<10;i++) setTimeout(spawnHeart, i*70);
      }

      /* Confetti */
      function confettiBurst(){
        const colors = ["#ff7ac3","#b89bff","#ffd1ea","#9be9c3","#ffe08a"];
        for(let i=0;i<44;i++){
          const p = document.createElement("div");
          p.style.position = "fixed";
          p.style.left = (50 + (Math.random()*30-15)) + "vw";
          p.style.top = (40 + (Math.random()*10-5)) + "vh";
          p.style.width = (6 + Math.random()*6) + "px";
          p.style.height = (6 + Math.random()*10) + "px";
          p.style.background = colors[Math.floor(Math.random()*colors.length)];
          p.style.borderRadius = "3px";
          p.style.opacity = ".95";
          p.style.zIndex = 80;
          p.style.transform = "translate(-50%,-50%) rotate("+(Math.random()*180)+"deg)";
          document.body.appendChild(p);

          const dx = (Math.random()*2-1) * 180;
          const dy = 220 + Math.random()*180;
          const rot = (Math.random()*2-1) * 260;
          const dur = 650 + Math.random()*550;

          p.animate([
            { transform:`translate(-50%,-50%) translate(0,0) rotate(0deg)`, opacity:.95 },
            { transform:`translate(-50%,-50%) translate(${dx}px,${dy}px) rotate(${rot}deg)`, opacity:0 }
          ], { duration: dur, easing:"cubic-bezier(.2,.8,.2,1)" });

          setTimeout(()=>p.remove(), dur+60);
        }
      }

      function celebrate(){
        confettiBurst();
        heartBurst();
      }

      /* Save / UI */
      function saveState(){
        localStorage.setItem(LS_KEY, JSON.stringify(state));
        updateUIBits();
      }

      function computeProgress(){
        let done = 0;
        const steps = {
          letter: !!state.visited.letter,
          photos: !!state.visited.photos,
          quiz: !!state.quizPassed,
          ask: !!state.askUnlocked
        };
        done += steps.letter ? 1 : 0;
        done += steps.photos ? 1 : 0;
        done += steps.quiz ? 1 : 0;
        done += steps.ask ? 1 : 0;
        const percent = Math.round((done/4)*100);
        return { steps, percent };
      }

      function updateProgressUI(){
        const { steps, percent } = computeProgress();
        $("progBar").style.width = percent + "%";
        $("progPercent").textContent = percent + "%";
        $("sLetter").classList.toggle("done", steps.letter);
        $("sPhotos").classList.toggle("done", steps.photos);
        $("sQuiz").classList.toggle("done", steps.quiz);
        $("sAsk").classList.toggle("done", steps.ask);
      }

      function updateUIBits(){
        $("toggleMusic").classList.toggle("on", state.musicOn);
        $("toggleHearts").classList.toggle("on", state.heartsOn);

        $("btnMusic").classList.toggle("off", !state.musicOn);
        $("musicState").textContent = state.musicOn ? "ON" : "OFF";

        $("btnHearts").classList.toggle("off", !state.heartsOn);
        $("heartsState").textContent = state.heartsOn ? "ON" : "OFF";

        $("fsState").textContent = state.fullscreen ? "CINE" : "FULL";
        document.body.classList.toggle("fullscreen", state.fullscreen);

        const pill = $("statusPill");
        const unlocked = !!state.askUnlocked;
        pill.textContent = unlocked ? "Pregunta: desbloqueada âœ…" : "Pregunta: bloqueada";
        pill.classList.toggle("good", unlocked);
        pill.classList.toggle("bad", !unlocked);

        if(state.heartsOn){
          startHearts();
        }else{
          stopHearts();
          clearHearts();
        }

        if(state.musicOn){
          // iOS requiere gesto: esto se dispara desde click/toggle
        }else{
          audio.pause();
        }

        updateProgressUI();
      }

      function safeScrollTop(){
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      /* Routes */
      function render(route){
        safeScrollTop();
        view.innerHTML = "";
        view.classList.remove("fade-in");
        void view.offsetWidth;
        view.classList.add("fade-in");

        if(route === "home") renderHome();
        if(route === "letter") renderLetter();
        if(route === "photos") renderPhotos();
        if(route === "quiz") renderQuiz();
        if(route === "ask") renderAsk();

        updateUIBits();
      }

      function renderHome(){
        state.visited.home = true;
        saveState();

        const askLocked = !state.askUnlocked;

        view.innerHTML = `
          <div class="section-head">
            <div>
              <h2 style="margin:0;">MenÃº</h2>
              <p class="sub" style="margin-top:4px;">Todo estÃ¡ hecho para ti âœ¨</p>
            </div>
            <div class="hint-badge">ğŸ  inicio</div>
          </div>

          <div class="menu-grid">
            <div class="tile" data-go="letter">
              <div class="t-title">ğŸ’Œ Carta</div>
              <div class="t-desc">Para leerla con calma (y con cariÃ±o).</div>
            </div>
            <div class="tile" data-go="photos">
              <div class="t-title">ğŸ“¸ Fotos</div>
              <div class="t-desc">Un collage con nuestros momentos.</div>
            </div>
            <div class="tile" data-go="quiz">
              <div class="t-title">ğŸ§  Mini test</div>
              <div class="t-desc">Desbloquea la sorpresa final.</div>
            </div>
            <div class="tile ${askLocked ? "locked" : ""}" data-go="${askLocked ? "" : "ask"}">
              <div class="t-title">ğŸ’˜ Pregunta</div>
              <div class="t-desc">${askLocked ? "Se desbloquea con el mini test." : "Ya estÃ¡ lista para ti ğŸ˜¼ğŸ’—"}</div>
            </div>
          </div>

          <div class="progress-wrap" style="margin-top:14px;">
            <div style="font-weight:900; color:rgba(43,36,51,.78);">
              Tip: completa el mini test para desbloquear la <b>Pregunta</b> ğŸ’
            </div>
          </div>
        `;

        view.querySelectorAll("[data-go]").forEach(el=>{
          el.addEventListener("click", ()=>{
            const go = el.getAttribute("data-go");
            if(!go) return;
            render(go);
          }, { passive:true });
        });
      }

      /* Letter */
      const LETTER_TEXT = `Holi mi amor, mi princesa, mi niÃ±a hermosa, mi todo; te dedico esta pequeÃ±a cartita con todo mi corazÃ³n.

Quiero que sepas que haces mis dÃ­as mejores. TambiÃ©n quiero decirte que me haces muy feliz. Me gusta lo que hacemos juntos, lo que estamos logrando juntos, las visiones que tenemos juntosâ€¦ y tambiÃ©n hasta por las veces que no estamos de acuerdo.

Soy muy feliz a tu lado; la verdad, nunca quiero irme de estoâ€¦ estoy muy seguro. Quiero que sepas que tienes mi lealtad y mi fidelidad.

Me encanta tu sonrisa, tus ojos, la manera en que me vesâ€¦ incluso cuando estÃ¡s enojada o de mal humor, hshs. Muchas cosas pudiera decirte, pero no lo quiero hacer muy largoâ€¦ solo espero que te guste <3

Quiero que sepas tambiÃ©n que eres el amor de mi vida y te amo mucho como no tienes idea, mi amor. Siempre quiero estar junto a ti: aun cuando no nos entendamos, aun en nuestros malos ratosâ€¦ y claro, aÃºn mÃ¡s en nuestros mejores momentos.

De verdad, contigo estoy muy seguro de todo, y de las cosas que quiero hacer junto a ti.

Con mucho amor te hago esta carta. No solo de labios, sino de corazÃ³nâ€¦ y con mucho amor, solo para ti, mi vida.

QuerÃ­a hacerte algo diferenteâ€¦ algo muy â€œyoâ€, pero totalmente â€œtÃºâ€.

Gracias por estar conmigo, por quererme como soy, y por hacer mis dÃ­as mÃ¡s bonitos.

Me encantas. Me inspiras. Y me haces sentir en casa.`;

      const LETTER_SIGN = `Con mucho cariÃ±o y amor,
tu hombre que te ama, Sergio ğŸ’—
(si no eres tÃº, entonces no lo darÃ© todo)`;

      let typingTimer = null;
      let typingToken = 0;

      function stopTyping(clear=false){
        typingToken++;
        if(typingTimer){ clearInterval(typingTimer); typingTimer = null; }
        if(clear){
          const el = $("letterBody");
          if(el) el.textContent = "";
        }
      }

      function typeLetter(){
        stopTyping(true);
        const token = ++typingToken;

        const bodyEl = $("letterBody");
        const signEl = $("letterSign");
        const surpriseEl = $("surpriseBox");
        const noteEl = $("noteBox");

        signEl.textContent = "";
        surpriseEl.style.display = "none";
        noteEl.style.display = "none";

        const full = LETTER_TEXT;
        let i = 0;

        typingTimer = setInterval(()=>{
          if(token !== typingToken){
            clearInterval(typingTimer);
            typingTimer = null;
            return;
          }
          i++;
          bodyEl.textContent = full.slice(0,i);

          if(i >= full.length){
            clearInterval(typingTimer);
            typingTimer = null;
            signEl.textContent = LETTER_SIGN;

            celebrate();              // âœ… confetti + hearts al terminar
            surpriseEl.style.display = "block";

            state.visited.letter = true;
            saveState();
          }
        }, 14);
      }

      function renderLetter(){
        state.visited.letter = true;
        saveState();

        view.innerHTML = `
          <div class="section-head">
            <div class="crumb">
              <div class="back" id="backHome">â† MenÃº</div>
              <div>Una carta para ti ğŸ’Œ</div>
            </div>
            <div class="hint-badge">carta</div>
          </div>

          <div class="paper">
            <div class="paper-inner" id="letterBody"></div>
            <div class="paper-sign" id="letterSign"></div>

            <div class="surprise" id="surpriseBox">
              <div class="s-title">ğŸ¥ºğŸ’— Una cosita mÃ¡sâ€¦</div>
              <div class="s-text">TÃ³came, porfa ğŸ˜½âœ¨</div>
              <div style="margin-top:10px;">
                <div class="mini-btn" id="btnSurprise">ğŸ’Œ Abrir</div>
              </div>

              <div class="note" id="noteBox">
                <div class="big">TE AMO</div>
                <div class="mini-btn" id="btnTeAmo">TE AMO ğŸ’—</div>
              </div>
            </div>
          </div>

          <div class="letter-actions">
            <div class="mini-btn" id="btnReread">âœ¨ Releer con efecto</div>
            <div class="mini-btn" id="btnGoQuiz">ğŸ§  Ir al mini test</div>
          </div>
        `;

        $("backHome").onclick = ()=> render("home");
        $("btnReread").onclick = ()=> typeLetter();
        $("btnGoQuiz").onclick = ()=> render("quiz");

        $("btnSurprise").onclick = ()=>{
          $("noteBox").style.display = "block";
          heartBurst();
        };

        $("btnTeAmo").onclick = ()=> celebrate();

        typeLetter();
      }

      /* Photos data */
      const photosData = [
        { file:"assets/photos/01.jpeg", cap:`Los mejores momentos son cuando nos reÃ­mos juntos ğŸ’ğŸ˜¹` },
        { file:"assets/photos/02.png",  cap:`La mejor biker ğŸï¸ğŸ’—` },
        { file:"assets/photos/03.jpeg", cap:`Me gusta cuando me abrazas ğŸ§¸ğŸ¤` },
        { file:"assets/photos/04.jpeg", cap:`Mi copilota <3 ğŸ˜½ğŸ’` },
        { file:"assets/photos/05.png",  cap:`Bonitos outfits âœ¨ğŸ’–` },
        { file:"assets/photos/06.jpeg", cap:`Enamorado de tu hermosa carita! ğŸ¥ºğŸ’—` },
        { file:"assets/photos/07.jpeg", cap:`Me cautiva tu belleza ğŸ’˜âœ¨` }
      ];

      function photoCardHTML(p, h=260){
        return `
          <div class="photo" style="height:${h}px;" data-photo>
            <img src="${p.file}" alt="foto" loading="lazy" />
            <div class="cap">${p.cap}</div>
          </div>
        `;
      }

      function renderPhotos(){
        state.visited.photos = true;
        saveState();

        view.innerHTML = `
          <div class="section-head">
            <div class="crumb">
              <div class="back" id="backHome">â† MenÃº</div>
              <div>Nuestros momentos ğŸ“¸</div>
            </div>
            <div class="hint-badge">fotos</div>
          </div>

          <p class="sub">Un collageâ€¦ completo y con estilito ğŸ˜Œ</p>

          <div class="collage">
            <div class="col">
              ${photoCardHTML(photosData[0], 320)}
              ${photoCardHTML(photosData[4], 250)}
            </div>

            <div class="col">
              ${photoCardHTML(photosData[1], 230)}
              ${photoCardHTML(photosData[2], 230)}
              ${photoCardHTML(photosData[3], 230)}
            </div>
          </div>

          <div style="margin-top:12px;">
            ${photoCardHTML(photosData[5], 280)}
          </div>
          <div style="margin-top:12px;">
            ${photoCardHTML(photosData[6], 280)}
          </div>

          <div class="tap-hint">Tip: toca cualquier foto para un â€œlikeâ€ rÃ¡pido ğŸ’—</div>
        `;

        $("backHome").onclick = ()=> render("home");

        view.querySelectorAll("[data-photo]").forEach(card=>{
          card.addEventListener("click", ()=>{
            const img = card.querySelector("img");
            img.animate([{transform:"scale(1)"},{transform:"scale(1.03)"},{transform:"scale(1)"}],
              { duration: 240, easing:"ease-out" });

            const h = document.createElement("div");
            h.className = "pop-heart";
            h.textContent = "ğŸ’—";
            card.appendChild(h);
            setTimeout(()=>h.remove(), 700);
            heartBurst();
          }, { passive:true });
        });
      }

      /* Quiz */
      const quiz = [
        { title: "1) Â¿QuÃ© prefiero hacer? ğŸ˜¼", options: ["Ir al gym ğŸ’ª", "Ir a la escuela ğŸ“š", "Jugar videojuegos ğŸ®"], correct: 0 },
        { title: "2) Â¿QuÃ© estilo de moto prefiero? ğŸï¸", options: ["Naked ğŸ˜ˆ", "Deportiva ğŸ", "2 tiempos ğŸ’¨"], correct: 0 },
        { title: "3) Â¿Me amas? ğŸ¥ºğŸ’—", options: ["SÃ­ ğŸ’", "No ğŸ™„"], correct: 0 }
      ];

      function renderQuiz(){
        state.visited.quiz = true;
        saveState();

        view.innerHTML = `
          <div class="section-head">
            <div class="crumb">
              <div class="back" id="backHome">â† MenÃº</div>
              <div>Mini test ğŸ§ </div>
            </div>
            <div class="hint-badge">test</div>
          </div>

          <p class="sub">RespÃ³ndelo bien y se desbloquea la sorpresa final ğŸ’˜</p>

          <div class="quiz" id="quizBox"></div>

          <div class="quiz-actions">
            <div class="mini-btn" id="btnSend">âœ… Enviar</div>
            <div class="mini-btn" id="btnResetQuiz">ğŸ” Limpiar</div>
          </div>

          <div class="toast" id="toast"></div>
        `;

        $("backHome").onclick = ()=> render("home");

        const box = $("quizBox");
        const selected = new Array(quiz.length).fill(null);

        quiz.forEach((q, qi)=>{
          const qEl = document.createElement("div");
          qEl.className = "q";
          qEl.innerHTML = `
            <h3>${q.title}</h3>
            <div class="opts">
              ${q.options.map((o, oi)=>`<div class="opt" data-q="${qi}" data-o="${oi}">${o}</div>`).join("")}
            </div>
          `;
          box.appendChild(qEl);
        });

        box.querySelectorAll(".opt").forEach(opt=>{
          opt.addEventListener("click", ()=>{
            const qi = Number(opt.getAttribute("data-q"));
            const oi = Number(opt.getAttribute("data-o"));
            selected[qi] = oi;
            box.querySelectorAll(\`.opt[data-q="\${qi}"]\`).forEach(x=>x.classList.remove("selected"));
            opt.classList.add("selected");
          }, { passive:true });
        });

        function showToast(msg, kind){
          const t = $("toast");
          if(!msg){ t.style.display="none"; t.className="toast"; t.textContent=""; return; }
          t.style.display="block";
          t.className = "toast " + (kind==="good" ? "good" : "bad");
          t.textContent = msg;
        }

        $("btnResetQuiz").onclick = ()=>{
          selected.fill(null);
          box.querySelectorAll(".opt").forEach(x=>x.classList.remove("selected"));
          showToast("", "");
        };

        $("btnSend").onclick = ()=>{
          for(let i=0;i<selected.length;i++){
            if(selected[i] === null){ showToast("Te falta una ğŸ˜¼ (responde todas)", "bad"); return; }
          }
          for(let i=0;i<quiz.length;i++){
            if(selected[i] !== quiz[i].correct){
              showToast("Uy no ğŸ˜¹ Intenta otra vez, mi amor ğŸ’—", "bad");
              return;
            }
          }

          state.quizPassed = true;
          state.askUnlocked = true;
          saveState();

          celebrate();
          showToast("Perfecto âœ… Ya se desbloqueÃ³ la Pregunta ğŸ’˜", "good");
          setTimeout(()=> render("home"), 900);
        };
      }

      /* Final ask */
      function renderAsk(){
        if(!state.askUnlocked){ render("home"); return; }
        state.visited.ask = true;
        saveState();

        view.innerHTML = `
          <div class="section-head">
            <div class="crumb">
              <div class="back" id="backHome">â† MenÃº</div>
              <div>Pregunta final ğŸ’˜</div>
            </div>
            <div class="hint-badge">final</div>
          </div>

          <div class="final">
            <h3>Â¿Quieres ser mi San ValentÃ­n? ğŸ’—</h3>
            <p>(elige tu vibra ğŸ˜¼)</p>

            <div class="yn">
              <div class="yes" id="btnYes">SÃ­ ğŸ’</div>
              <div class="no" id="btnNo">No ğŸ™„</div>
            </div>

            <div class="final-msg" id="finalMsg">Ayyy sÃ­ ğŸ˜­ğŸ’— ya sabÃ­aaaaa. Te amo muchÃ­simo ğŸ˜½âœ¨</div>
          </div>
        `;

        $("backHome").onclick = ()=> render("home");

        const btnNo = $("btnNo");
        const btnYes = $("btnYes");
        let dodgeCount = 0;

        function dodge(){
          const box = view.querySelector(".final");
          const rect = box.getBoundingClientRect();
          const pad = 14;
          const maxX = rect.width - 110;
          const maxY = rect.height - 90;

          const x = pad + Math.random() * (maxX - pad);
          const y = 70 + Math.random() * (maxY - 70);

          btnNo.style.position = "absolute";
          btnNo.style.left = x + "px";
          btnNo.style.top = y + "px";

          dodgeCount++;
          const scale = Math.max(0.72, 1 - dodgeCount*0.06);
          btnNo.style.transform = `scale(${scale})`;

          if(dodgeCount >= 6){
            btnNo.textContent = "SÃ­ ğŸ’";
            btnNo.onclick = ()=> acceptYes();
          }
        }

        function acceptYes(){
          $("finalMsg").style.display = "block";
          celebrate();
          state.visited.ask = true;
          saveState();
        }

        btnYes.onclick = acceptYes;
        btnNo.addEventListener("mouseenter", dodge);
        btnNo.addEventListener("click", dodge);
        btnNo.addEventListener("touchstart", (e)=>{ e.preventDefault(); dodge(); }, { passive:false });
      }

      /* Buttons (Top + Panel) */
      function toggleMusic(){
        state.musicOn = !state.musicOn;
        saveState();
        if(state.musicOn){
          audio.volume = 0.9;
          audio.play().catch(()=>{ /* iOS needs gesture; but this IS gesture */ });
        }else{
          audio.pause();
        }
      }

      function toggleHearts(){
        state.heartsOn = !state.heartsOn;
        saveState();
      }

      $("btnMusic").addEventListener("click", toggleMusic);
      $("toggleMusic").addEventListener("click", toggleMusic);

      $("btnHearts").addEventListener("click", toggleHearts);
      $("toggleHearts").addEventListener("click", toggleHearts);

      $("btnConfetti").addEventListener("click", celebrate);
      $("ctrlConfetti").addEventListener("click", celebrate);

      $("btnFullscreen").addEventListener("click", ()=>{
        state.fullscreen = !state.fullscreen;
        saveState();
      });

      $("btnCopy").addEventListener("click", async ()=>{
        const url = location.href;
        try{
          await navigator.clipboard.writeText(url);
          const btn = $("btnCopy");
          const old = btn.textContent;
          btn.textContent = "âœ… Copiado";
          setTimeout(()=> btn.textContent = old, 900);
        }catch{
          prompt("Copia este link:", url);
        }
      });

      $("btnReset").addEventListener("click", ()=>{
        if(confirm("Â¿Seguro? Esto borra el progreso guardado ğŸ˜¼")){
          localStorage.removeItem(LS_KEY);
          state = clone(defaultState);
          stopHearts();
          clearHearts();
          audio.pause();
          render("home");
          updateUIBits();
        }
      });

      /* Start */
      if(state.heartsOn) startHearts();
      updateUIBits();
      render("home");
    });
  </script>
</body>
</html>
